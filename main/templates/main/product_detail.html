{% load static %}
<!DOCTYPE html>
<html lang="uz" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>FAW Trucks - Mahsulot</title>
    <meta name="description" content="FAW Trucks в Узбекистане">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Фавикон -->
    <link rel="shortcut icon" href="{% static 'images/icon/favicon_5.ico' %}" type="image/x-icon" />

    <!-- Подключение стилей -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/loaders/loader.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/plugins.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/main_site.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/faw_main-models.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_main.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/more_info.css' %}">

    <!-- Цвет браузера -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FAF7F6">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#161616">

    <!-- Стили для loader -->
    <style>
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .page-loader .loader {
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }

        .error-page {
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-content {
            text-align: center;
            padding: 40px;
        }

        .error-content h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-content p {
            font-size: 20px;
            margin-bottom: 30px;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- Меню и шапка -->
    {% include 'main/includes/header.html' %}

    <!-- Контент страницы -->
    <main id="mxd-page-content" class="mxd-page-content">

        <!-- Секция героя -->
        <div class="mxd-section">
            <div class="mxd-hero-06">
                <div class="mxd-hero-06__wrap loading-wrap">
                    <div class="mxd-hero-06__top">
                        <div class="mxd-hero-06__content">
                            <div class="mxd-hero-06__data">
                                <div class="mxd-hero-06__headline">
                                    <div class="hero-06-headline__descr">
                                        <div class="row g-0 more_info-block">
                                            <div class="col-12 col-xl-12 mxd-grid-item no-margin">
                                                <div class="mxd-section-models__title">
                                                    <!-- Заголовок загружается через JS -->
                                                    <h2 class="models_title">Yuklanmoqda...</h2>
                                                    <ul class="more_info-link">
                                                        <li><a href="#parametrs">Parametrlar</a></li>
                                                        <li><a href="#gallery">Galereya</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mxd-hero-06__car">
                                <div class="col-12 col-xl-8 mxd-grid-item no-margin">
                                    <div class="mxd-section-title__hrdescr">
                                        <span class="hero-05-title__row loading__item">
                                            <em class="hero-05-title__item title-item-image">
                                                <svg class="mxd-pulse" xmlns="http://www.w3.org/2000/svg" version="1.1"
                                                    viewBox="0 0 20 20">
                                                    <path
                                                        d="M19.6,9.6h-3.9c-.4,0-1.8-.2-1.8-.2-.6,0-1.1-.2-1.6-.6-.5-.3-.9-.8-1.2-1.2-.3-.4-.4-.9-.5-1.4,0,0,0-1.1-.2-1.5V.4c0-.2-.2-.4-.4-.4s-.4.2-.4.4v4.4c0,.4-.2,1.5-.2,1.5,0,.5-.2,1-.5,1.4-.3.5-.7.9-1.2,1.2s-1,.5-1.6.6c0,0-1.2,0-1.7.2H.4c-.2,0-.4.2-.4.4s.2.4.4.4h4.1c.4,0,1.7.2,1.7.2.6,0,1.1.2,1.6.6.4.3.8.7,1.1,1.1.3.5.5,1,.6,1.6,0,0,0,1.3.2,1.7v4.1c0,.2.2.4.4.4s.4-.2.4-.4v-4.1c0-.4.2-1.7.2-1.7,0-.6.2-1.1.6-1.6.3-.4.7-.8,1.1-1.1.5-.3,1-.5,1.6-.6,0,0,1.3,0,1.8-.2h3.9c.2,0,.4-.2.4-.4s-.2-.4-.4-.4h0Z" />
                                                </svg>
                                            </em>
                                            <em class="hero-05-title__item" style="font-size: 25px; max-width: 400px;">
                                                Har qanday yomon yo'l muammosi to'g'risida xabar bering
                                            </em>
                                        </span>
                                        <a class="btn btn-anim btn-default btn-mobile-icon btn-outline slide-right-up mt-3"
                                            href="#faw-main-contact-modal" aria-label="Narxini bilish">
                                            <span class="btn-caption">Narxini bilish</span>
                                            <i class="ph-bold ph-arrow-up-right"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="car-img_block">
                                    <!-- Главное изображение загружается через JS -->
                                    <img src="{% static 'images/more_info.png' %}" class="mxd-hero-06__car-image"
                                        alt="FAW Truck">
                                </div>
                                <div class="car-img_block-info">
                                    <!-- 8 характеристик загружаются через JS -->
                                    <div class="car-specs-grid">
                                        <!-- Loader для характеристик -->
                                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #999;">
                                            Yuklanmoqda...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Секция параметров -->
        <div class="mxd-section padding-blog">
            <div class="grid-container">

                <!-- Хлебные крошки -->
                <div class="mxd-block">
                    <div class="mxd-section-more_info pre-grid">
                        <div class="mxd-section-more_info__inner animate-card-3">
                            <div class="mxd-grid-item">
                                <div class="section-more_info">
                                    <div aria-label="breadcrumb">
                                        <ol class="breadcrumb-ol">
                                            <li><a href="{% url 'home' %}">Bosh sahifa</a></li>
                                            <li><a href="javascript:void(0)">Modellar</a></li>
                                            <li class="active"><a href="javascript:void(0)">Yuklanmoqda...</a></li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Параметры (accordion) -->
                <div class="mxd-block" id="parametrs">
                    <div class="mxd-blog-preview">
                        <div class="container-fluid p-0">
                            <div class="g-0 card_block">
                                <div class="acardeon-cards_container">
                                    <h2 class="acardeon-cards_title">Parametrlar</h2>
                                    <!-- Accordion загружается через JS -->
                                    <div class="acardeon-cards_block">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            Yuklanmoqda...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Галерея -->
            <div class="mxd-section padding-pre-grid section-galery" id="gallery">
                <div class="grid-container">
                    <div class="mxd-block">
                        <h2 class="reveal-type anim-uni-in-up" style="text-align: center;">Galereya</h2>
                        <div class="mxd-demo-swiper mxd-grid-item anim-uni-in-up" data-custom-init="true"
                            style="min-height: 420px;">
                            <!-- Галерея загружается через JS -->
                            <div class="swiper-wrapper">
                                <div style="text-align: center; padding: 100px; color: #999;">
                                    Yuklanmoqda...
                                </div>
                            </div>
                            <!-- Кнопки навигации -->
                            <div class="swiper-button-prev mxd-slider-btn mxd-slider-btn-round-prev v2">
                                <a class="btn btn-round btn-round-small btn-outline slide-left anim-no-delay" href="#0">
                                    <i class="ph ph-arrow-left"></i>
                                </a>
                            </div>
                            <div class="swiper-button-next mxd-slider-btn mxd-slider-btn-round-next v2">
                                <a class="btn btn-round btn-round-small btn-outline slide-right anim-no-delay"
                                    href="#0">
                                    <i class="ph ph-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Футер -->
    {% include 'main/includes/footer.html' %}

    <!-- Кнопка «вверх» -->
    <a href="#0" id="to-top" class="btn btn-to-top slide-up anim-no-delay">
        <i class="ph ph-arrow-up"></i>
    </a>

    <!-- Модальное окно с формой контакта -->
    <div id="faw-modal" class="faw-modal">
        <div class="faw-modal__overlay"></div>
        <div class="faw-modal__content">
            <button class="faw-modal__close" aria-label="Закрыть">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="faw-modal__header">
                <h2 class="faw-modal__title">Biz bilan bog'laning</h2>
                <p class="faw-modal__subtitle">Ma'lumotlaringizni qoldiring, mutaxassislarimiz siz bilan bog'lanishadi
                </p>
            </div>

            <form class="faw-modal__form" id="faw-contact-form">
                {% csrf_token %}
                <input type="hidden" name="project_name" value="FAW Trucks">
                <input type="hidden" name="admin_email" value="info@fawtrucks.uz">
                <input type="hidden" name="form_subject" value="FAW Contact Form Message">

                <input type="hidden" name="product" id="product-field" value="">

                <div class="faw-form__group">
                    <input type="text" name="Name" class="faw-form__input" placeholder="Ismingiz*" required>
                </div>

                <div class="faw-form__group">
                    <select name="Region" class="faw-form__select" required>
                        <option value="" disabled selected>Viloyatni tanlang*</option>
                        <option value="Toshkent shahri">Toshkent shahri</option>
                        <option value="Andijon viloyati">Andijon viloyati</option>
                        <option value="Buxoro viloyati">Buxoro viloyati</option>
                        <option value="Fargʻona viloyati">Fargʻona viloyati</option>
                        <option value="Jizzax viloyati">Jizzax viloyati</option>
                        <option value="Xorazm viloyati">Xorazm viloyati</option>
                        <option value="Namangan viloyati">Namangan viloyati</option>
                        <option value="Navoiy viloyati">Navoiy viloyati</option>
                        <option value="Qashqadaryo viloyati">Qashqadaryo viloyati</option>
                        <option value="Samarqand viloyati">Samarqand viloyati</option>
                        <option value="Sirdaryo viloyati">Sirdaryo viloyati</option>
                        <option value="Surxondaryo viloyati">Surxondaryo viloyati</option>
                        <option value="Toshkent viloyati">Toshkent viloyati</option>
                        <option value="Qoraqalpogʻiston Respublikasi">Qoraqalpogʻiston Respublikasi</option>
                    </select>
                </div>

                <div class="faw-form__group">
                    <input type="tel" name="phone" class="faw-form__input" placeholder="+998 (__) ___-__-__"
                        id="phoneInput" pattern="[+]*[0-9\s\-\(\)]*" data-default="+998" required>
                </div>

                <div class="faw-form__group">
                    <textarea name="Message" class="faw-form__textarea"
                        placeholder="Qanday yuk mashinasiga qiziqasiz? Qo'shimcha savollar*" rows="4"
                        required></textarea>
                </div>

                <div class="faw-form__group">
                    <button type="submit" class="faw-form__submit">
                        <span>Qongʻiroq kutaman</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="7" y1="17" x2="17" y2="7"></line>
                            <polyline points="7 7 17 7 17 17"></polyline>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно для галереи -->
    <div id="gallery-modal" class="gallery-modal">
        <div class="gallery-modal__overlay"></div>
        <div class="gallery-modal__content">
            <button class="gallery-modal__close" aria-label="Закрыть">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <img id="gallery-modal-img" alt="Галерея" class="gallery-modal__img" />
        </div>
    </div>

    <!-- Подключение скриптов -->
    <script src="{% static 'js/libs.min.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'js/faw.js' %}"></script>
    <!-- Подключение Product Detail JS -->
    <script src="{% static 'js/product_detail.js' %}"></script>

    <script>
        // Форма контакта
        let isSubmitting = false;

        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('faw-modal');
            const modalOverlay = document.querySelector('.faw-modal__overlay');
            const modalClose = document.querySelector('.faw-modal__close');
            const contactForm = document.getElementById('faw-contact-form');
            const phoneInput = contactForm.querySelector('input[name="phone"]');
            const messageTextarea = contactForm.querySelector('textarea[name="Message"]');

            let statusBlock = contactForm.querySelector('.faw-form__status');
            if (!statusBlock) {
                statusBlock = document.createElement('div');
                statusBlock.className = 'faw-form__status hidden';
                const statusText = document.createElement('p');
                statusText.className = 'faw-form__status-text';
                statusBlock.appendChild(statusText);
                contactForm.prepend(statusBlock);
            }
            const statusText = statusBlock.querySelector('.faw-form__status-text') || statusBlock;

            // ← ФУНКЦИЯ СБОРА UTM
            function getUTMData() {
                const params = new URLSearchParams(window.location.search);
                const utm = {
                    utm_source: params.get('utm_source'),
                    utm_medium: params.get('utm_medium'),
                    utm_campaign: params.get('utm_campaign'),
                    utm_content: params.get('utm_content'),
                    utm_term: params.get('utm_term')
                };

                // Убираем пустые значения
                Object.keys(utm).forEach(key => {
                    if (!utm[key]) delete utm[key];
                });

                return Object.keys(utm).length > 0 ? JSON.stringify(utm) : null;
            }

            function openModal() {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';

                const productField = document.getElementById('product-field');
                if (window.currentProductTitle && productField) {
                    productField.value = window.currentProductTitle;
                }

                if (window.currentProductTitle && messageTextarea) {
                    messageTextarea.value = `Men ${window.currentProductTitle} modeliga qiziqaman.\n\nQo'shimcha savollar: `;
                    messageTextarea.focus();
                    messageTextarea.setSelectionRange(messageTextarea.value.length, messageTextarea.value.length);
                }
            }

            function closeModal() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            const modalTriggers = document.querySelectorAll('a[href="#faw-main-contact-modal"]');
            modalTriggers.forEach(trigger => {
                trigger.addEventListener('click', function (e) {
                    e.preventDefault();
                    openModal();
                });
            });

            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            });

            phoneInput.addEventListener("input", (e) => {
                let value = e.target.value.replace(/\D/g, "");
                if (!value.startsWith("998")) value = "998" + value;
                if (value.length > 12) value = value.slice(0, 12);

                let formatted = "+998 ";
                if (value.length > 3) formatted += "(" + value.slice(3, 5);
                if (value.length >= 5) formatted += ") " + value.slice(5, 8);
                if (value.length >= 8) formatted += "-" + value.slice(8, 10);
                if (value.length >= 10) formatted += "-" + value.slice(10, 12);

                e.target.value = formatted;
            });

            contactForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (isSubmitting) return;
                isSubmitting = true;

                const phone = phoneInput.value.replace(/\D/g, "");
                if (phone.length !== 12) {
                    showStatus("❌ Iltimos, telefon raqamingizni to'liq kiriting.", "error");
                    isSubmitting = false;
                    return;
                }

                // ← СОБИРАЕМ ВСЕ ДАННЫЕ (включая UTM и Referer)
                const formData = {
                    name: contactForm.Name.value,
                    region: contactForm.Region.value,
                    phone: phoneInput.value,
                    product: document.getElementById('product-field').value,
                    message: contactForm.Message.value,
                    referer: document.referrer || window.location.href,  // ← REFERER
                    utm_data: getUTMData()  // ← UTM
                };

                try {
                    const response = await fetch("/api/uz/contact/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": contactForm.querySelector("[name=csrfmiddlewaretoken]").value,
                        },
                        body: JSON.stringify(formData),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showStatus("✅ Xabar yuborildi! Tez orada siz bilan bog'lanamiz.", "success");
                        contactForm.reset();

                        setTimeout(() => {
                            closeModal();
                            statusBlock.classList.add("hidden");
                        }, 2000);
                    } else {
                        throw new Error(data.message || "Xatolik yuz berdi.");
                    }
                } catch (error) {
                    showStatus("❌ Xatolik yuz berdi. Qayta urinib ko'ring.", "error");
                } finally {
                    isSubmitting = false;
                }
            });

            function showStatus(message, type = "success") {
                statusText.textContent = message;
                statusBlock.className = `faw-form__status ${type} show`;
                statusBlock.classList.remove("hidden");

                setTimeout(() => {
                    statusBlock.classList.remove("show");
                    setTimeout(() => statusBlock.classList.add("hidden"), 400);
                }, 4000);
            }

            // Галерея - делегирование событий
            const galleryModal = document.getElementById('gallery-modal');
            const galleryModalImg = document.getElementById('gallery-modal-img');
            const galleryModalClose = document.querySelector('.gallery-modal__close');
            const galleryModalOverlay = document.querySelector('.gallery-modal__overlay');

            document.addEventListener('click', function (e) {
                if (e.target.closest('.swiper-wrapper img')) {
                    const img = e.target.closest('.swiper-wrapper img');
                    galleryModal.classList.add('active');
                    galleryModalImg.src = img.src;
                    galleryModalImg.alt = img.alt || '';
                    document.body.style.overflow = 'hidden';
                }
            });

            function closeGalleryModal() {
                galleryModal.classList.remove('active');
                galleryModalImg.src = '';
                document.body.style.overflow = '';
            }

            galleryModalClose.addEventListener('click', closeGalleryModal);
            galleryModalOverlay.addEventListener('click', closeGalleryModal);
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && galleryModal.classList.contains('active')) {
                    closeGalleryModal();
                }
            });
        });
    </script>
</body>

</html>