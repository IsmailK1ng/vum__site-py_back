<!-- templates/promotions/modal.html -->
{% load static %}
{% load i18n %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–∫—Ü–∏–π -->
<div id="promotionModal" class="promo-modal">
    <div class="promo-modal-content">
        <span class="promo-close">&times;</span>
        
        <div class="promo-slider">
            <!-- –°–ª–∞–π–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        

    </div>
</div>

<style>
.promo-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.promo-modal-content {
    position: relative;
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.promo-close {
    position: absolute;
    right: 15px;
    top: 15px;
    font-size: 32px;
    font-weight: bold;
    color: #fff;
    z-index: 100;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.5);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.promo-close:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: rotate(90deg);
}

.promo-slider {
    position: relative;
    overflow: hidden;
    min-height: 200px;
}

.promo-slide {
    display: none;
    animation: fadeIn 0.5s ease;
}

.promo-slide.active {
    display: block;
}

.promo-image {
    width: 100%;
    max-height: 400px;
    overflow: hidden;
    position: relative;
}

.promo-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.promo-prev,
.promo-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.4);
    color: white;
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    font-size: 28px;
    line-height: 1;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: center;
}

.promo-prev {
    left: 15px;
}

.promo-next {
    right: 15px;
}

.promo-prev:hover,
.promo-next:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

/* –¢–æ—á–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
.promo-dots {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 50;
    background: rgba(0, 0, 0, 0.4);
    padding: 8px 16px;
    border-radius: 20px;
    backdrop-filter: blur(5px);
}

.promo-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.promo-dot:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(1.2);
}

.promo-dot.active {
    background: #ffffff;
    transform: scale(1.4);
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
}

.promo-content {
    padding: 30px;
}

.promo-content h2 {
    margin: 0 0 15px 0;
    font-size: 28px;
    color: #333;
}

.promo-description {
    color: #666;
    line-height: 1.6;
    margin-bottom: 20px;
    font-size: 16px;
    white-space: pre-line;
}

.promo-button {
    display: inline-block;
    padding: 12px 30px;
    background: linear-gradient(135deg, #000000 0%, #696969 100%);
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.promo-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

@media (max-width: 768px) {
    .promo-modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .promo-content {
        padding: 20px;
    }
    
    .promo-content h2 {
        font-size: 22px;
    }
    
    .promo-prev,
    .promo-next {
        width: 35px;
        height: 35px;
        font-size: 22px;
    }
    
    .promo-prev {
        left: 10px;
    }
    
    .promo-next {
        right: 10px;
    }
    
    .promo-dots {
        bottom: 15px;
        padding: 6px 12px;
    }
    
    .promo-dot {
        width: 10px;
        height: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // console.log('üéØ Promotion modal script loaded');
    
    const modal = document.getElementById('promotionModal');
    const closeBtn = document.querySelector('.promo-close');
    const sliderContainer = document.querySelector('.promo-slider');
    
    let currentSlide = 0;
    let promotions = [];
    let viewedPromotions = [];
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ —è–∑—ã–∫–∞ (uz, ru, en) ‚Äî –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ —Å –¥—Ä—É–≥–∏–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
    const currentLang = (document.documentElement.lang ||
        (typeof window !== 'undefined' && window.LANGUAGE_CODE) ||
        getCookie('django_language') ||
        'uz').split('-')[0].toLowerCase();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏–∑ cookie
    loadViewedPromotions();
    // console.log('üëÅÔ∏è Viewed promotions:', viewedPromotions);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ API
    const apiUrl = `/api/${currentLang}/promotions/`;
    // console.log('üì° Fetching promotions from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            // console.log('üì• Response status:', response.status);
            return response.json();
        })
        .then(data => {
            // console.log('üì¶ Promotions data:', data);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤ –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å results)
            const allPromotions = Array.isArray(data) ? data : (data.results || []);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
            promotions = allPromotions.filter(promo => !isPromotionViewed(promo.id));
            
            // console.log(`‚úÖ Total: ${allPromotions.length} promotions, Unviewed: ${promotions.length}`);
            
            if (promotions.length > 0) {
                renderSlides();
                setTimeout(() => {
                    // console.log('‚è∞ Showing modal after 1 second');
                    showModal();
                }, 1000);
            } else {
                // console.log('‚ú® All promotions have been viewed today');
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading promotions:', error);
        });
    
    function renderSlides() {
        // console.log('üé® Rendering slides...');
        sliderContainer.innerHTML = '';
        
        promotions.forEach((promo, index) => {
            // console.log(`  - Slide ${index + 1}:`, promo.title);
            
            // –°–æ–∑–¥–∞—ë–º —Å–ª–∞–π–¥
            const slide = document.createElement('div');
            slide.className = 'promo-slide';
            slide.dataset.promoId = promo.id;
            
            let html = '';
            
            if (promo.image_url) {
                html += `<div class="promo-image">`;
                html += `<img src="${promo.image_url}" alt="${promo.title}">`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1 –∞–∫—Ü–∏–∏
                if (promotions.length > 1) {
                    html += `
                        <button class="promo-prev" data-action="prev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">‚Äπ</button>
                        <button class="promo-next" data-action="next" aria-label="–°–ª–µ–¥—É—é—â–∞—è">‚Ä∫</button>
                        <div class="promo-dots"></div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `
                <div class="promo-content">
                    <h2>${promo.title}</h2>
                    <div class="promo-description">${promo.description}</div>
            `;
            
            if (promo.link) {
                html += `
                    <a href="${promo.link}" class="promo-button" target="_blank">
                        ${promo.button_text}
                    </a>
                `;
            }
            
            html += '</div>';
            slide.innerHTML = html;
            sliderContainer.appendChild(slide);
        });
        
        // –°–æ–∑–¥–∞—ë–º —Ç–æ—á–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞
        if (promotions.length > 1) {
            const dotsContainers = document.querySelectorAll('.promo-dots');
            
            dotsContainers.forEach(dotsContainer => {
                dotsContainer.innerHTML = '';
                
                for (let i = 0; i < promotions.length; i++) {
                    const dot = document.createElement('span');
                    dot.className = 'promo-dot';
                    if (i === 0) dot.classList.add('active');
                    dot.dataset.slide = i;
                    dot.addEventListener('click', () => showSlide(i));
                    dotsContainer.appendChild(dot);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ prev/next
            document.querySelectorAll('.promo-prev').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSlide(currentSlide - 1);
                });
            });
            
            document.querySelectorAll('.promo-next').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showSlide(currentSlide + 1);
                });
            });
        }
        
        // console.log('‚úÖ Slides rendered');
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
    function loadViewedPromotions() {
        const cookie = getCookie('viewedPromotions');
        if (cookie) {
            try {
                const data = JSON.parse(decodeURIComponent(cookie));
                const today = new Date().toDateString();
                
                // –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ cookie —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è - –∑–∞–≥—Ä—É–∂–∞–µ–º ID
                if (data.date === today) {
                    viewedPromotions = data.ids || [];
                } else {
                    // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                    viewedPromotions = [];
                    clearViewedPromotions();
                }
            } catch (e) {
                console.error('Error parsing viewed promotions:', e);
                viewedPromotions = [];
            }
        }
    }
    
    function saveViewedPromotions() {
        const today = new Date().toDateString();
        const data = {
            date: today,
            ids: viewedPromotions
        };
        
        const expires = new Date();
        expires.setHours(23, 59, 59, 999); // –î–æ –∫–æ–Ω—Ü–∞ –¥–Ω—è
        
        document.cookie = `viewedPromotions=${encodeURIComponent(JSON.stringify(data))};expires=${expires.toUTCString()};path=/`;
        // console.log('üíæ Saved viewed promotions:', viewedPromotions);
    }
    
    function clearViewedPromotions() {
        document.cookie = 'viewedPromotions=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/';
    }
    
    function isPromotionViewed(promoId) {
        return viewedPromotions.includes(promoId);
    }
    
    function markPromotionAsViewed(promoId) {
        if (!viewedPromotions.includes(promoId)) {
            viewedPromotions.push(promoId);
            saveViewedPromotions();
            // console.log(`‚úì Promotion ${promoId} marked as viewed`);
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    
    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/`;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function showModal() {
        if (promotions.length > 0) {
            // console.log('üëÅÔ∏è Showing modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            showSlide(0);
            
            // –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∞–∫—Ü–∏—é –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—É—é
            markPromotionAsViewed(promotions[0].id);
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function closeModal() {
        // console.log('‚ùå Closing modal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–æ–≤
    function showSlide(n) {
        const slides = document.querySelectorAll('.promo-slide');
        const allDots = document.querySelectorAll('.promo-dot');
        
        if (slides.length === 0) return;
        
        slides.forEach(slide => slide.classList.remove('active'));
        allDots.forEach(dot => dot.classList.remove('active'));
        
        currentSlide = (n + slides.length) % slides.length;
        
        slides[currentSlide].classList.add('active');
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
        allDots.forEach(dot => {
            if (parseInt(dot.dataset.slide) === currentSlide) {
                dot.classList.add('active');
            }
        });
        
        // –ü–æ–º–µ—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∞–∫—Ü–∏—é –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—É—é
        if (promotions[currentSlide]) {
            markPromotionAsViewed(promotions[currentSlide].id);
        }
        
        // console.log('üìç Showing slide:', currentSlide + 1);
    }
    
    // –°–æ–±—ã—Ç–∏—è
    closeBtn.addEventListener('click', closeModal);
    
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModal();
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal.style.display === 'block') {
            closeModal();
        }
    });
});
</script>