{% load static %}
{% load seo_tags %} 
<!DOCTYPE html>
<html dir="ltr" lang="{{ LANGUAGE_CODE|default:'uz' }}">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Page Title -->
    <title>{% if LANGUAGE_CODE == 'uz' %}Lizing{% elif LANGUAGE_CODE == 'ru' %}Лизинг{% else %}Leasing{% endif %} | FAW Trucks</title>
    {% hreflang_tags %}
    {% canonical_url %}
    <!-- Meta Tags -->
    <meta name="description" content="{% if LANGUAGE_CODE == 'uz' %}FAW Trucks lizing xizmatlari O'zbekistonda - qulay shartlar, tez rasmiylashtirish{% elif LANGUAGE_CODE == 'ru' %}Лизинговые услуги FAW Trucks в Узбекистане - удобные условия, быстрое оформление{% else %}FAW Trucks leasing services in Uzbekistan - convenient terms, fast processing{% endif %}">
    <meta name="keywords" content="FAW Trucks, {% if LANGUAGE_CODE == 'uz' %}lizing, O'zbekiston{% elif LANGUAGE_CODE == 'ru' %}лизинг, Узбекистан{% else %}leasing, Uzbekistan{% endif %}">
    <meta name="author" content="mix_design">

    <!-- Favicon -->
    <link rel="icon" href="{% static 'images/logo/logo-vum.png' %}" />
    <link rel="apple-touch-icon" href="{% static 'images/logo/logo-vum.png' %}">

    <!-- Open Graph -->
    <meta property="og:title" content="{% if LANGUAGE_CODE == 'uz' %}Lizing{% elif LANGUAGE_CODE == 'ru' %}Лизинг{% else %}Leasing{% endif %} | FAW Trucks">
    <meta property="og:description" content="{% if LANGUAGE_CODE == 'uz' %}Qulay lizing shartlari{% elif LANGUAGE_CODE == 'ru' %}Удобные условия лизинга{% else %}Convenient leasing terms{% endif %}">
    <meta property="og:url" content="https://fawtrucks.uz/lizing">
    <meta property="og:image" content="{% static 'images/lizing.png' %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M33GWKMW');</script>

    <!-- Meta Pixel -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '2271244510044933');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=2271244510044933&ev=PageView&noscript=1" /></noscript>

    <!-- Preload Critical CSS -->
    <link rel="preload" href="{% static 'css/main_site.css' %}" as="style">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/loaders/loader.css' %}">
    <link rel="stylesheet" href="{% static 'css/plugins.css' %}">
    <link rel="stylesheet" href="{% static 'css/main_site.css' %}">
    <link rel="stylesheet" href="{% static 'css/site_main.css' %}">
    <link rel="stylesheet" href="{% static 'css/site_lizing.css' %}">

    <!-- Theme Colors -->
    <meta name="theme-color" content="#FAF7F6" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
    <meta name="msapplication-navbutton-color" content="#161616">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LecXTAsAAAAAN5LP2bcc7RHYV-0clG7B9p7KZow"></script>
    <!-- Стили для модальных окон -->
    <style>
        .faw-modal {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99999;
            align-items: center;
            justify-content: center;
        }

        .faw-modal.active {
            display: flex !important;
        }

        .faw-modal__overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1;
        }

        .faw-modal__content {
            position: relative;
            z-index: 2;
            background: white;
            border-radius: 8px;
            padding: 40px;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .faw-modal__close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: color 0.2s;
            z-index: 3;
        }

        .faw-modal__close:hover {
            color: #000;
        }

        .faw-modal__header {
            margin-bottom: 25px;
        }

        .faw-modal__title {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        .faw-modal__subtitle {
            font-size: 14px;
            color: #666;
            margin: 0;
            line-height: 1.6;
        }

        .faw-modal__form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .faw-form__group {
            display: flex;
            flex-direction: column;
        }

        .faw-form__input,
        .faw-form__select,
        .faw-form__textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .faw-form__input:focus,
        .faw-form__select:focus,
        .faw-form__textarea:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
        }

        .faw-form__submit {
            padding: 12px 20px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.3s;
        }

        .faw-form__submit:hover {
            background: #555;
        }

        .faw-form__status {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            transition: opacity 0.3s;
        }

        .faw-form__status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .faw-form__status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .faw-form__status.hidden {
            display: none;
        }

        .faw-form__status.show {
            display: block;
            opacity: 1;
        }

        [data-theme="dark"] .faw-modal__content {
            background: #222;
            color: #fff;
        }

        [data-theme="dark"] .faw-modal__close {
            color: #ccc;
        }

        [data-theme="dark"] .faw-form__input,
        [data-theme="dark"] .faw-form__select,
        [data-theme="dark"] .faw-form__textarea {
            background: #333;
            color: #fff;
            border-color: #444;
        }

        [data-theme="dark"] .faw-form__submit {
            background: #666;
        }

        [data-theme="dark"] .faw-modal__subtitle {
            color: #bbb;
        }

        #downloadPdfBtn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        #downloadPdfBtn:hover {
            background: #555;
        }

        [data-theme="dark"] #downloadPdfBtn {
            background: #666;
        }

        [data-theme="dark"] #downloadPdfBtn:hover {
            background: #888;
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M33GWKMW" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <!-- Header -->
    {% include 'main/includes/header.html' %}

    <!-- Page Content -->
    <main id="mxd-page-content" class="mxd-page-content">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb-ol">
                <li><a href="{% url 'home' %}">{% if LANGUAGE_CODE == 'uz' %}Bosh sahifa{% elif LANGUAGE_CODE == 'ru' %}Главная{% else %}Home{% endif %}</a></li>
                <li class="active"><a href="{% url 'lizing' %}">{% if LANGUAGE_CODE == 'uz' %}Lizing{% elif LANGUAGE_CODE == 'ru' %}Лизинг{% else %}Leasing{% endif %}</a></li>
            </ol>
        </nav>

        <!-- Hero Section -->
        <section class="mxd-section">
            <div class="mxd-hero-09">
                <div class="mxd-hero-09__wrap loading-wrap lizing__hero-cont">
                    <div class="mxd-hero-09__headline">
                        <div class="hero-09-headline__caption loading__item">
                            <h1>{% if LANGUAGE_CODE == 'uz' %}LIZING{% elif LANGUAGE_CODE == 'ru' %}ЛИЗИНГ{% else %}LEASING{% endif %}</h1>
                            <p class="mxd-hero-09__desc">
                                {% if LANGUAGE_CODE == 'uz' %}
                                Lizing orqali siz o'zingizga kerakli FAW yuk mashinasini sotib olishingiz mumkin. Bizning lizing shartlarimiz moslashuvchan bo'lib, sizning biznesingiz ehtiyojlariga mos keladi.
                                {% elif LANGUAGE_CODE == 'ru' %}
                                С помощью лизинга вы можете приобрести необходимый грузовой автомобиль FAW. Наши условия лизинга гибкие и соответствуют потребностям вашего бизнеса.
                                {% else %}
                                Through leasing, you can purchase the FAW truck you need. Our leasing terms are flexible and meet your business needs.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="mxd-hero-09__objects">
                        <div class="hero-09-objects__image loading__item">
                            <img class="mxd-move" src="{% static 'images/lizing.png' %}" alt="{% if LANGUAGE_CODE == 'uz' %}Lizing{% elif LANGUAGE_CODE == 'ru' %}Лизинг{% else %}Leasing{% endif %}">
                        </div>
                        <div class="hero-09-objects__item item-03 loading__item">
                            <div class="mxd-hero__mark">
                                <span class="mark-icon"></span>
                                <span class="mark-text">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Tez rasmiylashtirish
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Быстрое оформление
                                    {% else %}
                                    Fast processing
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="lizing-calc__title">
                        <h2 class="calc-title">
                            {% if LANGUAGE_CODE == 'uz' %}
                            Lizing kalkulatori
                            {% elif LANGUAGE_CODE == 'ru' %}
                            Лизинговый калькулятор
                            {% else %}
                            Leasing Calculator
                            {% endif %}
                        </h2>
                    </div>
                </div>
            </div>
        </section>

        <!-- Leasing Calculator -->
        <section class="mxd-section">
            <div class="mxd-hero-09">
                <div class="mxd-hero-06__wrap loading-wrap">
                    <div class="mxd-hero-06__top">
                        <div class="mxd-hero-06__content">
                            <div class="lizing-calc-container">
                                <div class="lizing-form-section">
                                    <!-- Vehicle Price -->
                                    <div class="lizing-form-group">
                                        <label>
                                            {% if LANGUAGE_CODE == 'uz' %}
                                            Texnika narxi
                                            {% elif LANGUAGE_CODE == 'ru' %}
                                            Стоимость техники
                                            {% else %}
                                            Vehicle Price
                                            {% endif %}
                                        </label>
                                        <input type="text" class="lizing-input-field" id="amountInput" value="300 000 000 so'm">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="amountSlider" min="250000000" max="600000000" value="300000000" step="1000000">
                                            <div class="lizing-slider-labels">
                                                <span>250 {% if LANGUAGE_CODE == 'uz' %}mln. so'm{% elif LANGUAGE_CODE == 'ru' %}млн. сум{% else %}mln. sum{% endif %}</span>
                                                <span>400 {% if LANGUAGE_CODE == 'uz' %}mln. so'm{% elif LANGUAGE_CODE == 'ru' %}млн. сум{% else %}mln. sum{% endif %}</span>
                                                <span>600 {% if LANGUAGE_CODE == 'uz' %}mln. so'm{% elif LANGUAGE_CODE == 'ru' %}млн. сум{% else %}mln. sum{% endif %}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Down Payment -->
                                    <div class="lizing-form-group">
                                        <label>
                                            {% if LANGUAGE_CODE == 'uz' %}
                                            Dastlabki to'lov
                                            {% elif LANGUAGE_CODE == 'ru' %}
                                            Первоначальный взнос
                                            {% else %}
                                            Down Payment
                                            {% endif %}
                                        </label>
                                        <input type="text" class="lizing-input-field" id="downPaymentInput" value="120 000 000 so'm">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="downPaymentSlider" min="0"  max="60" value="40" step="1">
                                            <div class="lizing-slider-labels">
                                                <span>0%</span>
                                                <span>30%</span>
                                                <span>60%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Lease Term -->
                                    <div class="lizing-form-group">
                                        <label>
                                            {% if LANGUAGE_CODE == 'uz' %}
                                            Lizing muddati
                                            {% elif LANGUAGE_CODE == 'ru' %}
                                            Срок лизинга
                                            {% else %}
                                            Lease Term
                                            {% endif %}
                                        </label>
                                        <input type="text" class="lizing-input-field" id="termInput" value="24 {% if LANGUAGE_CODE == 'uz' %}oy{% elif LANGUAGE_CODE == 'ru' %}мес{% else %}mo{% endif %}">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="termSlider" min="12" max="60" value="24" step="1">
                                            <div class="lizing-slider-labels">
                                                <span>12 {% if LANGUAGE_CODE == 'uz' %}oy{% elif LANGUAGE_CODE == 'ru' %}мес{% else %}mo{% endif %}</span>
                                                <span>33 {% if LANGUAGE_CODE == 'uz' %}oy{% elif LANGUAGE_CODE == 'ru' %}мес{% else %}mo{% endif %}</span>
                                                <span>60 {% if LANGUAGE_CODE == 'uz' %}oy{% elif LANGUAGE_CODE == 'ru' %}мес{% else %}mo{% endif %}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Results Section -->
                                <div class="lizing-result-section">
                                    <div class="lizing-result-amount">
                                        {% if LANGUAGE_CODE == 'uz' %}
                                        Moliyalashtirish summasi
                                        {% elif LANGUAGE_CODE == 'ru' %}
                                        Сумма финансирования
                                        {% else %}
                                        Financing Amount
                                        {% endif %}
                                        <div class="lizing-result-value" id="financeAmount">180 900 000 so'm</div>
                                    </div>
                                    
                                    <div class="lizing-payment-info">
                                        <div>
                                            <div class="lizing-monthly-label">
                                                {% if LANGUAGE_CODE == 'uz' %}
                                                Oylik to'lov
                                                {% elif LANGUAGE_CODE == 'ru' %}
                                                Ежемесячный платеж
                                                {% else %}
                                                Monthly Payment
                                                {% endif %}
                                            </div>
                                            <div class="lizing-monthly-value" id="monthlyPayment">8 625 000 {% if LANGUAGE_CODE == 'uz' %}so'mdan{% elif LANGUAGE_CODE == 'ru' %}сум от{% else %}sum from{% endif %}</div>
                                        </div>
                                        <div>
                                            <div class="lizing-monthly-label">
                                                {% if LANGUAGE_CODE == 'uz' %}
                                                Dastlabki to'lov
                                                {% elif LANGUAGE_CODE == 'ru' %}
                                                Первоначальный взнос
                                                {% else %}
                                                Down Payment
                                                {% endif %}
                                                <span class="lizing-info-icon">?</span>
                                            </div>
                                            <div class="lizing-payment-value" id="downPaymentAmount">40%</div>
                                        </div>
                                    </div>

                                    <div class="lizing-calculation-info">
                                        <div class="lizing-calculation-label">
                                            {% if LANGUAGE_CODE == 'uz' %}
                                            Hisob-kitob dastlabki
                                            {% elif LANGUAGE_CODE == 'ru' %}
                                            Предварительный расчет
                                            {% else %}
                                            Preliminary Calculation
                                            {% endif %}
                                            <span class="lizing-info-icon">?</span>
                                        </div>
                                        <div class="lizing-buttons">
                                            <button type="button" class="lizing-btn-secondary" id="detailsBtn">
                                                {% if LANGUAGE_CODE == 'uz' %}
                                                Lizing haqida batafsil
                                                {% elif LANGUAGE_CODE == 'ru' %}
                                                Подробнее о лизинге
                                                {% else %}
                                                Leasing Details
                                                {% endif %}
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    {% include 'main/includes/footer.html' %}

    <!-- To Top Button -->
    <a href="#0" id="to-top" class="btn btn-to-top slide-up anim-no-delay" aria-label="{% if LANGUAGE_CODE == 'uz' %}Yuqoriga{% elif LANGUAGE_CODE == 'ru' %}Наверх{% else %}To top{% endif %}">
        <i class="ph ph-arrow-up"></i>
    </a>

    <!-- MODAL -->
    <div id="detailsModal" class="modal">
        <div class="modal-wrapper">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">
                        {% if LANGUAGE_CODE == 'uz' %}
                        Lizing haqida batafsil ma'lumot
                        {% elif LANGUAGE_CODE == 'ru' %}
                        Подробная информация о лизинге
                        {% else %}
                        Detailed Leasing Information
                        {% endif %}
                    </h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="calculation-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Texnika narxi
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Стоимость техники
                                    {% else %}
                                    Vehicle Price
                                    {% endif %}
                                </div>
                                <div class="summary-value" id="modal-car-price">300 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Dastlabki to'lov
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Первоначальный взнос
                                    {% else %}
                                    Down Payment
                                    {% endif %}
                                </div>
                                <div class="summary-value" id="modal-initial-payment">120 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Lizing muddati
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Срок лизинга
                                    {% else %}
                                    Lease Term
                                    {% endif %}
                                </div>
                                <div class="summary-value" id="modal-term">24 {% if LANGUAGE_CODE == 'uz' %}oy{% elif LANGUAGE_CODE == 'ru' %}мес{% else %}mo{% endif %}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Oylik to'lov
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Ежемесячный платеж
                                    {% else %}
                                    Monthly Payment
                                    {% endif %}
                                </div>
                                <div class="summary-value primary" id="modal-monthly-payment">8 625 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Jami to'lov
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Общая сумма
                                    {% else %}
                                    Total Payment
                                    {% endif %}
                                </div>
                                <div class="summary-value" id="modal-total-payment">207 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">
                                    {% if LANGUAGE_CODE == 'uz' %}
                                    Foiz stavkasi
                                    {% elif LANGUAGE_CODE == 'ru' %}
                                    Процентная ставка
                                    {% else %}
                                    Interest Rate
                                    {% endif %}
                                </div>
                                <div class="summary-value" id="modal-rate">22%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Schedule -->
                    <div class="payment-schedule">
                        <h3 class="schedule-title">
                            {% if LANGUAGE_CODE == 'uz' %}
                            To'lov jadvali
                            {% elif LANGUAGE_CODE == 'ru' %}
                            График платежей
                            {% else %}
                            Payment Schedule
                            {% endif %}
                        </h3>
                        <div class="schedule-table-wrapper">
                            <table class="schedule-table">
                                <thead>
                                    <tr>
                                        <th>{% if LANGUAGE_CODE == 'uz' %}Oy{% elif LANGUAGE_CODE == 'ru' %}Месяц{% else %}Month{% endif %}</th>
                                        <th>{% if LANGUAGE_CODE == 'uz' %}Asosiy qarz{% elif LANGUAGE_CODE == 'ru' %}Основной долг{% else %}Principal{% endif %}</th>
                                        <th>{% if LANGUAGE_CODE == 'uz' %}Foizlar{% elif LANGUAGE_CODE == 'ru' %}Проценты{% else %}Interest{% endif %}</th>
                                        <th>{% if LANGUAGE_CODE == 'uz' %}Oylik to'lov{% elif LANGUAGE_CODE == 'ru' %}Ежемесячный платеж{% else %}Monthly Payment{% endif %}</th>
                                        <th>{% if LANGUAGE_CODE == 'uz' %}Qoldiq{% elif LANGUAGE_CODE == 'ru' %}Остаток{% else %}Balance{% endif %}</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Download PDF Button -->
                    <div class="modal-actions" style="margin-top: 30px; text-align: center; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                        <button id="downloadPdfBtn" class="btn btn-anim btn-default slide-right-up" style="cursor: pointer;">
                            <i class="ph ph-download"></i>
                            {% if LANGUAGE_CODE == 'uz' %}
                            Tahlilni PDF orqali yuklab olish
                            {% elif LANGUAGE_CODE == 'ru' %}
                            Скачать разбор в PDF
                            {% else %}
                            Download Analysis as PDF
                            {% endif %}
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для формы контакта по лизингу -->
    <div id="lizing-modal" class="faw-modal">
        <div class="faw-modal__overlay"></div>
        <div class="faw-modal__content">
            <button class="faw-modal__close" aria-label="Закрыть">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="faw-modal__header">
                <h2 class="faw-modal__title">
                    {% if LANGUAGE_CODE == 'ru' %}Приобрести по лизингу
                    {% elif LANGUAGE_CODE == 'en' %}Acquire by Leasing
                    {% else %}Lizing orqali sotib olish{% endif %}
                </h2>
                <p class="faw-modal__subtitle">
                    {% if LANGUAGE_CODE == 'ru' %}
                    Вы готовы приобрести грузовой автомобиль FAW по лизингу? Оставьте свои контактные данные, и наши специалисты по лизингу помогут вам выбрать оптимальные условия финансирования и быстро оформить все необходимые документы.
                    {% elif LANGUAGE_CODE == 'en' %}
                    Ready to acquire a FAW truck through leasing? Leave your contact details and our leasing specialists will help you choose the best financing terms and quickly process all necessary documents.
                    {% else %}
                    Siz FAW yuk mashinasini lizing orqali sotib olishga tayyormisiz? Aloqa ma'lumotlaringizni qoldiring, va bizning lizing mutaxassislari sizga eng yaxshi moliyaviy shartlarni tanlashda yordam beradilаr va kerakli hujjatlarni tez orada rasmiylashtiradi.
                    {% endif %}
                </p>
            </div>

            <form class="faw-modal__form" id="lizing-contact-form">
                {% csrf_token %}
                <input type="hidden" name="project_name" value="FAW Trucks - Лизинг">
                <input type="hidden" name="admin_email" value="info@fawtrucks.uz">
                <input type="hidden" name="form_subject" value="Заявка на лизинг FAW">
                <input type="hidden" name="product" value="FAW Trucks - Лизинг">

                <div class="faw-form__group">
                    <input type="text" name="Name" class="faw-form__input" 
                        {% if LANGUAGE_CODE == 'uz' %}
                        placeholder="Ismingiz*"
                        {% elif LANGUAGE_CODE == 'en' %}
                        placeholder="Your Name*"
                        {% else %}
                        placeholder="Ваше имя*"
                        {% endif %}
                        required>
                </div>

                <div class="faw-form__group">
                    <select name="Region" class="faw-form__select" required>
                        <option value="" disabled selected>
                            {% if LANGUAGE_CODE == 'ru' %}Выберите регион*
                            {% elif LANGUAGE_CODE == 'en' %}Select Region*
                            {% else %}Viloyatni tanlang*{% endif %}
                        </option>
                        <option value="Toshkent shahri">
                            {% if LANGUAGE_CODE == 'ru' %}г. Ташкент
                            {% elif LANGUAGE_CODE == 'en' %}Tashkent City
                            {% else %}Toshkent shahri{% endif %}
                        </option>
                        <option value="Andijon viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Андижанская область
                            {% elif LANGUAGE_CODE == 'en' %}Andijan Region
                            {% else %}Andijon viloyati{% endif %}
                        </option>
                        <option value="Buxoro viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Бухарская область
                            {% elif LANGUAGE_CODE == 'en' %}Bukhara Region
                            {% else %}Buxoro viloyati{% endif %}
                        </option>
                        <option value="Fargʻona viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Ферганская область
                            {% elif LANGUAGE_CODE == 'en' %}Fergana Region
                            {% else %}Fargʻona viloyati{% endif %}
                        </option>
                        <option value="Jizzax viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Джизакская область
                            {% elif LANGUAGE_CODE == 'en' %}Jizzakh Region
                            {% else %}Jizzax viloyati{% endif %}
                        </option>
                        <option value="Xorazm viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Хорезмская область
                            {% elif LANGUAGE_CODE == 'en' %}Khorezm Region
                            {% else %}Xorazm viloyati{% endif %}
                        </option>
                        <option value="Namangan viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Наманганская область
                            {% elif LANGUAGE_CODE == 'en' %}Namangan Region
                            {% else %}Namangan viloyati{% endif %}
                        </option>
                        <option value="Navoiy viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Навоийская область
                            {% elif LANGUAGE_CODE == 'en' %}Navoiy Region
                            {% else %}Navoiy viloyati{% endif %}
                        </option>
                        <option value="Qashqadaryo viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Кашкадарьинская область
                            {% elif LANGUAGE_CODE == 'en' %}Kashkadarya Region
                            {% else %}Qashqadaryo viloyati{% endif %}
                        </option>
                        <option value="Samarqand viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Самаркандская область
                            {% elif LANGUAGE_CODE == 'en' %}Samarkand Region
                            {% else %}Samarqand viloyati{% endif %}
                        </option>
                        <option value="Sirdaryo viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Сырдарьинская область
                            {% elif LANGUAGE_CODE == 'en' %}Sirdaryo Region
                            {% else %}Sirdaryo viloyati{% endif %}
                        </option>
                        <option value="Surxondaryo viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Сурхандарьинская область
                            {% elif LANGUAGE_CODE == 'en' %}Surkhandarya Region
                            {% else %}Surxondaryo viloyati{% endif %}
                        </option>
                        <option value="Toshkent viloyati">
                            {% if LANGUAGE_CODE == 'ru' %}Ташкентская область
                            {% elif LANGUAGE_CODE == 'en' %}Tashkent Region
                            {% else %}Toshkent viloyati{% endif %}
                        </option>
                        <option value="Qoraqalpog'iston Respublikasi">
                            {% if LANGUAGE_CODE == 'ru' %}Республика Каракалпакстан
                            {% elif LANGUAGE_CODE == 'en' %}Republic of Karakalpakstan
                            {% else %}Qoraqalpog'iston Respublikasi{% endif %}
                        </option>
                    </select>
                </div>

                <div class="faw-form__group">
                    <input type="tel" name="phone" class="faw-form__input" placeholder="+998 (__) ___-__-__"
                        id="lizingPhoneInput" pattern="[+]*[0-9\s\-\(\)]*" data-default="+998" required>
                </div>

                <div class="faw-form__group">
                    <textarea name="Message" class="faw-form__textarea"
                        {% if LANGUAGE_CODE == 'uz' %}
                        placeholder="Qanday yuk mashinasiga lizing orqali qiziqasiz?*"
                        {% elif LANGUAGE_CODE == 'en' %}
                        placeholder="What truck model are you interested in leasing?*"
                        {% else %}
                        placeholder="Какой грузовик FAW вас интересует по лизингу?*"
                        {% endif %}
                        rows="4" required></textarea>
                </div>

                <div class="faw-form__group">
                    <button type="submit" class="faw-form__submit">
                        <span>
                            {% if LANGUAGE_CODE == 'ru' %}Отправить заявку
                            {% elif LANGUAGE_CODE == 'en' %}Submit Request
                            {% else %}Arizani yubor{% endif %}
                        </span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="7" y1="17" x2="17" y2="7"></line>
                            <polyline points="7 7 17 7 17 17"></polyline>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'js/libs.min.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'js/error-logger.js' %}"></script>
    <script src="{% static 'js/faw.js' %}"></script>
    <!-- jsPDF для генерации PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>


    <!-- Scroll Script -->
    <script>
        (function () {
            function getHeaderHeight() {
                try { var h = document.getElementById('header'); return h ? h.offsetHeight || 0 : 0; } catch (e) { return 0; }
            }

            function scrollToElementById(id) {
                var el = document.getElementById(id);
                if (!el) return;
                var headerH = getHeaderHeight();
                var offset = 18;
                var rect = el.getBoundingClientRect();
                var targetY = Math.max(0, Math.round(window.pageYOffset + rect.top - headerH - offset));
                try { window.scrollTo({ top: targetY, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, targetY); }
            }

            document.addEventListener('click', function (e) {
                var a = e.target.closest && e.target.closest('a[href^="#"]');
                if (!a) return;
                var href = a.getAttribute('href');
                if (!href || href === '#') return;
                var id = href.slice(1);
                if (!id) return;
                if (document.getElementById(id)) {
                    e.preventDefault();
                    scrollToElementById(id);
                }
            }, false);
        })();
    </script>

    <!-- Leasing Calculator Script -->
    <script>
        const LANGUAGE_CODE = '{{ LANGUAGE_CODE|default:"uz" }}';
        const amountSlider = document.getElementById('amountSlider');
        const downPaymentSlider = document.getElementById('downPaymentSlider');
        const termSlider = document.getElementById('termSlider');
        const amountInput = document.getElementById('amountInput');
        const downPaymentInput = document.getElementById('downPaymentInput');
        const termInput = document.getElementById('termInput');
        const financeAmount = document.getElementById('financeAmount');
        const monthlyPayment = document.getElementById('monthlyPayment');
        const downPaymentAmount = document.getElementById('downPaymentAmount');
        let updatingFromSlider = false;
    let updatingFromInput = false;

    const TRANSLATIONS = {
        uz: {
            month: 'oy',
            from: "so'mdan",
            sum: "so'm"
        },
        ru: {
            month: 'мес',
            from: 'сум от',
            sum: 'сум'
        },
        en: {
            month: 'mo',
            from: 'sum from',
            sum: 'sum'
        }
    };

    const t = TRANSLATIONS[LANGUAGE_CODE] || TRANSLATIONS.uz;

    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU').format(num);
    }

    function parseAmount(text) {
        return parseInt(text.replace(/[^\d]/g, '')) || 0;
    }

    function parseTerm(text) {
        return parseInt(text.replace(/[^\d]/g, '')) || 0;
    }

    const AMOUNT_MIN = 250000000;
    const AMOUNT_MAX = 600000000;
    const DOWNPAY_MIN = 30;
    const DOWNPAY_MAX = 60;
    const TERM_MIN = 12;
    const TERM_MAX = 60;

    function calculateLeasing(carPrice, initialPaymentPercent, termInMonths) {
        let annualRate;
        if (termInMonths <= 24) {
            annualRate = 0.22;
        } else if (termInMonths <= 36) {
            annualRate = 0.23;
        } else if (termInMonths <= 48) {
            annualRate = 0.26;
        } else if (termInMonths <= 60) {
            annualRate = 0.265;
        } else {
            annualRate = 0.265;
        }

        const initialPayment = Math.round(carPrice * initialPaymentPercent / 100);
        const financingBase = carPrice - initialPayment;
        const additionalCosts = Math.round(financingBase * 0.005);
        const totalAmount = financingBase + additionalCosts;

        const monthlyRate = annualRate / 12;
        const annuityCoefficient = (monthlyRate * Math.pow(1 + monthlyRate, termInMonths)) / (Math.pow(1 + monthlyRate, termInMonths) - 1);
        const monthlyPayment = Math.round(totalAmount * annuityCoefficient);

        return {
            carPrice,
            initialPayment,
            financingBase,
            totalAmount,
            monthlyPayment,
            totalPayment: monthlyPayment * termInMonths,
            annualRate,
            termInMonths
        };
    }

    function generatePaymentSchedule(totalAmount, monthlyPayment, annualRate, termInMonths) {
        const schedule = [];
        let remainingDebt = totalAmount;
        const monthlyRate = annualRate / 12;

        for (let month = 1; month <= termInMonths; month++) {
            const interestPayment = Math.round(remainingDebt * monthlyRate);
            const principalPayment = monthlyPayment - interestPayment;
            remainingDebt = Math.max(0, remainingDebt - principalPayment);

            schedule.push({
                month,
                principalPayment,
                interestPayment,
                monthlyPayment,
                remainingDebt
            });
        }

        return schedule;
    }

    function updateFromSliders() {
        if (updatingFromInput) return;
        updatingFromSlider = true;

        const amount = parseInt(amountSlider.value);
        const downPaymentPercent = parseInt(downPaymentSlider.value);
        const term = parseInt(termSlider.value);
        const downPaymentSum = Math.round(amount * downPaymentPercent / 100);

        amountInput.value = `${formatNumber(amount)} ${t.sum}`;
        downPaymentInput.value = `${formatNumber(downPaymentSum)} ${t.sum}`;
        termInput.value = `${term} ${t.month}`;

        updateResults();
        updateSliderBackgrounds();
        updatingFromSlider = false;
    }

    function updateResults() {
        const amount = parseInt(amountSlider.value);
        const downPaymentPercent = parseInt(downPaymentSlider.value);
        const term = parseInt(termSlider.value);
        const result = calculateLeasing(amount, downPaymentPercent, term);

        financeAmount.textContent = `${formatNumber(result.totalAmount)} ${t.sum}`;
        monthlyPayment.textContent = `${formatNumber(result.monthlyPayment)} ${t.from}`;
        downPaymentAmount.textContent = `${downPaymentPercent}%`;
    }

    function updateSliderBackground(slider) {
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        const value = parseFloat(slider.value);
        const percentage = ((value - min) / (max - min)) * 100;
        slider.style.background = `linear-gradient(to right, black 0%, grey ${percentage}%, var(--base-shade) ${percentage}%, var(--base-shade) 100%)`;
    }

    function updateSliderBackgrounds() {
        updateSliderBackground(amountSlider);
        updateSliderBackground(downPaymentSlider);
        updateSliderBackground(termSlider);
    }

    // Event handlers
    amountSlider.addEventListener('input', updateFromSliders);
    downPaymentSlider.addEventListener('input', updateFromSliders);
    termSlider.addEventListener('input', updateFromSliders);

    amountInput.addEventListener('blur', function () {
        if (updatingFromSlider) return;
        updatingFromInput = true;
        const value = parseAmount(this.value);
        const clampedValue = Math.max(AMOUNT_MIN, Math.min(AMOUNT_MAX, value));
        amountSlider.value = clampedValue;
        this.value = `${formatNumber(clampedValue)} ${t.sum}`;
        const downPaymentPercent = parseInt(downPaymentSlider.value);
        const newDownPayment = Math.round(clampedValue * downPaymentPercent / 100);
        downPaymentInput.value = `${formatNumber(newDownPayment)} ${t.sum}`;
        updateResults();
        updateSliderBackgrounds();
        updatingFromInput = false;
    });

    downPaymentInput.addEventListener('blur', function () {
        if (updatingFromSlider) return;
        updatingFromInput = true;
        const value = parseAmount(this.value);
        const amount = parseInt(amountSlider.value);
        let percent = Math.round((value / amount) * 100);
        percent = Math.max(DOWNPAY_MIN, Math.min(DOWNPAY_MAX, percent));
        downPaymentSlider.value = percent;
        const exactDownPayment = Math.round(amount * percent / 100);
        this.value = `${formatNumber(exactDownPayment)} ${t.sum}`;
        updateResults();
        updateSliderBackgrounds();
        updatingFromInput = false;
    });

    termInput.addEventListener('blur', function () {
        if (updatingFromSlider) return;
        updatingFromInput = true;
        const value = parseTerm(this.value);
        const clampedValue = Math.max(TERM_MIN, Math.min(TERM_MAX, value));
        termSlider.value = clampedValue;
        this.value = `${clampedValue} ${t.month}`;
        updateResults();
        updateSliderBackgrounds();
        updatingFromInput = false;
    });

    amountInput.addEventListener('focus', function () {
        if (updatingFromSlider) return;
        const value = parseAmount(this.value);
        this.value = value.toString();
    });

    downPaymentInput.addEventListener('focus', function () {
        if (updatingFromSlider) return;
        const value = parseAmount(this.value);
        this.value = value.toString();
    });

    termInput.addEventListener('focus', function () {
        if (updatingFromSlider) return;
        const value = parseTerm(this.value);
        this.value = value.toString();
    });

    // Modal
    const modal = document.getElementById('detailsModal');
    const detailsBtn = document.getElementById('detailsBtn');
    const closeBtn = document.querySelector('.close');

    function fixModalScroll() {
        const modalWrapper = document.querySelector('.modal-wrapper');
        const modal = document.getElementById('detailsModal');

        if (modalWrapper && modal) {
            modalWrapper.addEventListener('wheel', function (e) {
                e.stopPropagation();
            }, { passive: false });

            modal.addEventListener('wheel', function (e) {
                if (e.target.closest('.modal-wrapper')) {
                    const wrapper = e.target.closest('.modal-wrapper');
                    const scrollTop = wrapper.scrollTop;
                    const scrollHeight = wrapper.scrollHeight;
                    const height = wrapper.clientHeight;
                    const wheelDelta = e.deltaY;
                    const scrollDown = wheelDelta > 0;

                    if (scrollDown && scrollTop + height >= scrollHeight) {
                        e.preventDefault();
                    } else if (!scrollDown && scrollTop <= 0) {
                        e.preventDefault();
                    } else {
                        e.stopPropagation();
                    }
                }
            }, { passive: false });
        }
    }

    function showModal() {
        const amount = parseInt(amountSlider.value);
        const downPaymentPercent = parseInt(downPaymentSlider.value);
        const term = parseInt(termSlider.value);
        const result = calculateLeasing(amount, downPaymentPercent, term);

        document.getElementById('modal-car-price').textContent = `${formatNumber(result.carPrice)} ${t.sum}`;
        document.getElementById('modal-initial-payment').textContent = `${formatNumber(result.initialPayment)} ${t.sum}`;
        document.getElementById('modal-term').textContent = `${term} ${t.month}`;
        document.getElementById('modal-monthly-payment').textContent = `${formatNumber(result.monthlyPayment)} ${t.sum}`;
        document.getElementById('modal-total-payment').textContent = `${formatNumber(result.totalPayment)} ${t.sum}`;
        document.getElementById('modal-rate').textContent = `${(result.annualRate * 100).toFixed(1)}%`;

        const schedule = generatePaymentSchedule(result.totalAmount, result.monthlyPayment, result.annualRate, term);
        const tbody = document.getElementById('schedule-tbody');
        tbody.innerHTML = '';

        schedule.forEach(payment => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${payment.month}</td>
                <td>${formatNumber(payment.principalPayment)} ${t.sum}</td>
                <td>${formatNumber(payment.interestPayment)} ${t.sum}</td>
                <td>${formatNumber(payment.monthlyPayment)} ${t.sum}</td>
                <td>${formatNumber(payment.remainingDebt)} ${t.sum}</td>
            `;
        });

        modal.classList.add('show');
        document.body.classList.add('modal-open');
        fixModalScroll();
        modal.focus();
    }

    function hideModal() {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }

    detailsBtn.addEventListener('click', function (event) {
        event.preventDefault();
        showModal();
    });
    closeBtn.addEventListener('click', hideModal);
    window.addEventListener('click', function (event) {
        if (event.target === modal || event.target.classList.contains('modal-wrapper')) {
            hideModal();
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            hideModal();
        }
    });

    const themeToggle = document.getElementById('color-switcher');
    if (themeToggle) {
        themeToggle.addEventListener('click', function () {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateSliderBackgrounds();
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
        }
    }

    // Initialize
    updateFromSliders();

    // ============ ОБРАБОТКА СКАЧИВАНИЯ PDF И ФОРМЫ ЛИЗИНГА ============
    // Выполняем код сразу или после загрузки всех элементов
    function initLizingModal() {
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const lizingModal = document.getElementById('lizing-modal');
        const lizingModalClose = document.querySelector('#lizing-modal .faw-modal__close');
        const lizingModalOverlay = document.querySelector('#lizing-modal .faw-modal__overlay');
        const lizingContactForm = document.getElementById('lizing-contact-form');
        const lizingPhoneInput = document.getElementById('lizingPhoneInput');
        let lizingIsSubmitting = false;

        console.log('=== Initializing lizing modal ===');
        console.log('downloadPdfBtn exists:', !!downloadPdfBtn);
        console.log('lizingModal exists:', !!lizingModal);
        console.log('lizingModalClose exists:', !!lizingModalClose);
        console.log('lizingModalOverlay exists:', !!lizingModalOverlay);
        console.log('lizingContactForm exists:', !!lizingContactForm);
        console.log('lizingPhoneInput exists:', !!lizingPhoneInput);

        if (!downloadPdfBtn || !lizingModal) {
            console.error('❌ PDF button or modal not found - initialization aborted');
            return;
        }

        console.log('✅ All elements found - initializing handlers');

        function openLizingModal() {
            console.log('📖 Opening lizing modal');
            console.log('Before: modal classes:', lizingModal.className);
            lizingModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('After: modal classes:', lizingModal.className);
            console.log('Modal display:', window.getComputedStyle(lizingModal).display);
        }

        function closeLizingModal() {
            console.log('📖 Closing lizing modal');
            lizingModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Кнопка скачивания PDF
        downloadPdfBtn.addEventListener('click', function (e) {
            e.preventDefault();
            console.log('🔘 PDF button clicked!');
            openLizingModal();
        });

        console.log('✅ PDF button click handler attached');

        // Закрытие модального окна
        if (lizingModalClose) {
            lizingModalClose.addEventListener('click', function (e) {
                console.log('✖️ Close button clicked');
                closeLizingModal();
            });
            console.log('✅ Close button handler attached');
        }
        if (lizingModalOverlay) {
            lizingModalOverlay.addEventListener('click', function (e) {
                console.log('✖️ Overlay clicked');
                closeLizingModal();
            });
            console.log('✅ Overlay click handler attached');
        }

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && lizingModal?.classList.contains('active')) {
                console.log('✖️ Escape key pressed');
                closeLizingModal();
            }
        });
        console.log('✅ Escape key handler attached');

        // Форматирование телефона
        if (lizingPhoneInput) {
            lizingPhoneInput.addEventListener("input", (e) => {
                let value = e.target.value.replace(/\D/g, "");
                if (!value.startsWith("998")) value = "998" + value;
                if (value.length > 12) value = value.slice(0, 12);

                let formatted = "+998 ";
                if (value.length > 3) formatted += "(" + value.slice(3, 5);
                if (value.length >= 5) formatted += ") " + value.slice(5, 8);
                if (value.length >= 8) formatted += "-" + value.slice(8, 10);
                if (value.length >= 10) formatted += "-" + value.slice(10, 12);

                e.target.value = formatted;
            });
            console.log('✅ Phone formatting handler attached');
        }

        // Обработка формы лизинга
        if (lizingContactForm) {
            lizingContactForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                console.log('📤 Form submitted');
                if (lizingIsSubmitting) return;
                lizingIsSubmitting = true;

                const phone = lizingPhoneInput.value.replace(/\D/g, "");
                if (phone.length !== 12) {
                    console.warn('⚠️ Invalid phone number:', lizingPhoneInput.value);
                    showLizingStatus("❌ Iltimos, telefon raqamingizni to'liq kiriting.", "error");
                    lizingIsSubmitting = false;
                    return;
                }

                try {
                    // ============ ПОЛУЧАЕМ ТОКЕН reCAPTCHA ============
                    const recaptchaToken = await grecaptcha.execute('6LecXTAsAAAAAN5LP2bcc7RHYV-0clG7B9p7KZow', {
                        action: 'contact_form'
                    });

                    const formData = {
                        name: lizingContactForm.Name.value,
                        region: lizingContactForm.Region.value,
                        phone: lizingPhoneInput.value,
                        product: 'FAW Trucks - Лизинг',
                        message: lizingContactForm.Message.value || '',
                        referer: window.location.href,
                        utm_data: window.getUTMData ? JSON.stringify(window.getUTMData()) : '{}',
                        visitor_uid: sessionStorage.getItem('amo_visitor_uid') || null,
                        recaptcha_token: recaptchaToken  // ← ТОКЕН
                    };

                    console.log('📊 Form data:', formData);

                    console.log('📤 Sending POST request to /api/uz/contact/');
                    const response = await fetch("/api/uz/contact/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": lizingContactForm.querySelector("[name=csrfmiddlewaretoken]").value,
                        },
                        body: JSON.stringify(formData),
                    });

                    console.log('📨 Response status:', response.status);
                    const data = await response.json();
                    console.log('📨 Response data:', data);

                    if (response.ok) {
                        console.log('✅ Form sent successfully');
                        (window.dataLayer = window.dataLayer || []).push({
                            event: "leasing_form_submitted"
                        });

                        showLizingStatus("✅ Xabar yuborildi! Tez orada siz bilan bog'lanamiz.", "success");
                        
                        // Генерируем и скачиваем PDF с данными лизинга
                        generateAndDownloadLizingPDF();
                        
                        lizingContactForm.reset();

                        setTimeout(() => {
                            closeLizingModal();
                        }, 2000);
                    } else if (response.status === 400) {
                        console.error('❌ Validation errors from API:', data.errors || data);
                        throw new Error(`Validation error: ${JSON.stringify(data.errors || data.message)}`);
                    } else {
                        throw new Error(`API Error ${response.status}: ${data.message || 'Unknown error'}`);
                    }
                } catch (err) {
                    console.error("❌ Form error:", err);
                    showLizingStatus("❌ Xatolik yuz berdi. Iltimos, qayta urinib ko'ring.", "error");
                } finally {
                    lizingIsSubmitting = false;
                }
            });
            console.log('✅ Form submit handler attached');
        }

        function showLizingStatus(message, type = "success") {
            let statusBlock = lizingContactForm.querySelector('.faw-form__status');
            if (!statusBlock) {
                statusBlock = document.createElement('div');
                statusBlock.className = 'faw-form__status hidden';
                const statusText = document.createElement('p');
                statusText.className = 'faw-form__status-text';
                statusBlock.appendChild(statusText);
                lizingContactForm.prepend(statusBlock);
            }

            const statusText = statusBlock.querySelector('.faw-form__status-text') || statusBlock;
            statusText.textContent = message;
            statusBlock.className = `faw-form__status ${type} show`;
            statusBlock.classList.remove("hidden");

            setTimeout(() => {
                statusBlock.classList.remove("show");
                setTimeout(() => statusBlock.classList.add("hidden"), 400);
            }, 4000);
        }

        console.log('=== Lizing modal initialization complete! ===');
    }

// ============ ЗАГРУЗКА ШРИФТА И ГЕНЕРАЦИЯ PDF ============

// Функция для загрузки шрифта и конвертации в base64
async function loadFont(url) {
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const uint8Array = new Uint8Array(arrayBuffer);
    let binary = '';
    for (let i = 0; i < uint8Array.length; i++) {
        binary += String.fromCharCode(uint8Array[i]);
    }
    return btoa(binary);
}

// Основная функция генерации PDF
async function generateAndDownloadLizingPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Загружаем шрифт Roboto с поддержкой кириллицы
        const fontUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf';
        
        try {
            const fontBase64 = await loadFont(fontUrl);
            doc.addFileToVFS('Roboto-Regular.ttf', fontBase64);
            doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
            doc.setFont('Roboto');
        } catch (fontError) {
            console.warn('Font loading failed, using default font:', fontError);
            doc.setFont('helvetica');
        }

        const amount = parseInt(amountSlider.value);
        const downPaymentPercent = parseInt(downPaymentSlider.value);
        const term = parseInt(termSlider.value);

        const result = calculateLeasing(amount, downPaymentPercent, term);
        const schedule = generatePaymentSchedule(
            result.totalAmount,
            result.monthlyPayment,
            result.annualRate,
            term
        );

        const today = new Date().toLocaleDateString('ru-RU');

        // Переплата
        const overpayment = result.totalPayment - result.totalAmount;
        const overpaymentPercent = ((overpayment / result.totalAmount) * 100).toFixed(1);

        // Тексты в зависимости от языка
        const texts = {
            ru: {
                dealer: 'Официальный дилер в Узбекистане',
                title: 'РАСЧЁТ ЛИЗИНГА',
                date: 'Дата',
                monthlyPayment: 'Ежемесячный платёж',
                currency: 'сум',
                parameter: 'Параметр',
                value: 'Значение',
                vehiclePrice: 'Стоимость техники',
                downPayment: 'Первоначальный взнос',
                financingAmount: 'Сумма финансирования',
                leaseTerm: 'Срок лизинга',
                months: 'мес',
                interestRate: 'Процентная ставка',
                perYear: 'годовых',
                totalPayments: 'Сумма всех платежей',
                interestPaid: 'Переплата (проценты)',
                totalWithDown: 'Общая сумма с взносом',
                conditions: 'Условия лизинга',
                cond1: 'Минимальный взнос - от 0%',
                cond2: 'Максимальный срок - 60 месяцев',
                cond3: 'Быстрое оформление (1-2 дня)',
                cond4: 'Досрочное погашение',
                cond5: 'Техника становится вашей',
                cond6: 'Без кредитной истории',
                cond7: 'КАСКО обязательно',
                cond8: 'Индивидуальный подход',
                scheduleTitle: 'График ежемесячных платежей',
                term: 'Срок',
                rate: 'Ставка',
                principal: 'Основной долг',
                interest: 'Проценты',
                payment: 'Платёж',
                balance: 'Остаток',
                total: 'ИТОГО',
                warning: 'Важно:',
                warningText: 'Данный расчёт является предварительным. Уточняйте условия у менеджера.',
                page: 'Стр.'
            },
            uz: {
                dealer: "O'zbekistondagi rasmiy dilyer",
                title: 'LIZING HISOBLASH',
                date: 'Sana',
                monthlyPayment: "Oylik to'lov",
                currency: "so'm",
                parameter: 'Parametr',
                value: 'Qiymati',
                vehiclePrice: 'Texnika narxi',
                downPayment: "Dastlabki to'lov",
                financingAmount: 'Moliyalashtirish summasi',
                leaseTerm: 'Lizing muddati',
                months: 'oy',
                interestRate: 'Foiz stavkasi',
                perYear: 'yillik',
                totalPayments: "Jami to'lovlar",
                interestPaid: "Qo'shimcha (foizlar)",
                totalWithDown: 'Umumiy summa',
                conditions: 'Lizing shartlari',
                cond1: "Minimal to'lov - 0% dan",
                cond2: 'Maksimal muddat - 60 oy',
                cond3: 'Tez rasmiylashtirish (1-2 kun)',
                cond4: "Muddatidan oldin to'lash",
                cond5: "Texnika sizniki bo'ladi",
                cond6: 'Kredit tarixisiz',
                cond7: "KASKO sug'urta majburiy",
                cond8: 'Individual yondashuv',
                scheduleTitle: "Oylik to'lovlar jadvali",
                term: 'Muddat',
                rate: 'Stavka',
                principal: 'Asosiy qarz',
                interest: 'Foizlar',
                payment: "To'lov",
                balance: 'Qoldiq',
                total: 'JAMI',
                warning: 'Muhim:',
                warningText: "Ushbu hisob-kitob dastlabki. Yakuniy shartlarni menejer bilan aniqlang.",
                page: 'Sahifa'
            },
            en: {
                dealer: 'Official Dealer in Uzbekistan',
                title: 'LEASING CALCULATION',
                date: 'Date',
                monthlyPayment: 'Monthly Payment',
                currency: 'UZS',
                parameter: 'Parameter',
                value: 'Value',
                vehiclePrice: 'Vehicle Price',
                downPayment: 'Down Payment',
                financingAmount: 'Financing Amount',
                leaseTerm: 'Lease Term',
                months: 'months',
                interestRate: 'Interest Rate',
                perYear: 'per year',
                totalPayments: 'Total Payments',
                interestPaid: 'Interest Paid',
                totalWithDown: 'Total with Down Payment',
                conditions: 'Leasing Terms',
                cond1: 'Minimum down payment - from 0%',
                cond2: 'Maximum term - 60 months',
                cond3: 'Fast processing (1-2 days)',
                cond4: 'Early repayment option',
                cond5: 'Vehicle becomes yours',
                cond6: 'No credit history required',
                cond7: 'CASCO insurance mandatory',
                cond8: 'Individual approach',
                scheduleTitle: 'Monthly Payment Schedule',
                term: 'Term',
                rate: 'Rate',
                principal: 'Principal',
                interest: 'Interest',
                payment: 'Payment',
                balance: 'Balance',
                total: 'TOTAL',
                warning: 'Important:',
                warningText: 'This calculation is preliminary. Please confirm terms with our manager.',
                page: 'Page'
            }
        };

        const txt = texts[LANGUAGE_CODE] || texts.ru;

        /* ================= HEADER ================= */
        doc.setFillColor(26, 58, 82);
        doc.rect(0, 0, 210, 28, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text('VUM/FAW TRUCKS', 105, 14, { align: 'center' });

        doc.setFontSize(10);
        doc.text(txt.dealer, 105, 20, { align: 'center' });
        
        doc.setFontSize(8);
        doc.text('faw.uz | +998 (55) 508-60-60', 105, 25, { align: 'center' });

        /* ================= TITLE ================= */
        doc.setTextColor(26, 58, 82);
        doc.setFontSize(16);
        doc.text(txt.title, 105, 38, { align: 'center' });

        doc.setFontSize(9);
        doc.setTextColor(128, 128, 128);
        doc.text(`${txt.date}: ${today}`, 105, 44, { align: 'center' });

        /* ================= MONTHLY PAYMENT BOX ================= */
        doc.setFillColor(26, 58, 82);
        doc.roundedRect(20, 50, 170, 28, 3, 3, 'F');

        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text(txt.monthlyPayment, 105, 59, { align: 'center' });

        doc.setFontSize(24);
        doc.text(`${formatNumber(result.monthlyPayment)} ${txt.currency}`, 105, 70, { align: 'center' });

        /* ================= PARAMETERS TABLE ================= */
        doc.setTextColor(0, 0, 0);

        doc.autoTable({
            startY: 88,
            theme: 'striped',
            styles: { 
                fontSize: 10, 
                cellPadding: 4,
                font: 'Roboto'
            },
            headStyles: {
                fillColor: [26, 58, 82],
                textColor: 255
            },
            columnStyles: {
                0: { cellWidth: 90 },
                1: { cellWidth: 80, halign: 'right' }
            },
            head: [[txt.parameter, txt.value]],
            body: [
                [txt.vehiclePrice, `${formatNumber(result.carPrice)} ${txt.currency}`],
                [txt.downPayment, `${formatNumber(result.initialPayment)} ${txt.currency} (${downPaymentPercent}%)`],
                [txt.financingAmount, `${formatNumber(result.totalAmount)} ${txt.currency}`],
                [txt.leaseTerm, `${term} ${txt.months}`],
                [txt.interestRate, `${(result.annualRate * 100).toFixed(1)}% ${txt.perYear}`],
                [txt.totalPayments, `${formatNumber(result.totalPayment)} ${txt.currency}`],
                [txt.interestPaid, `${formatNumber(overpayment)} ${txt.currency} (${overpaymentPercent}%)`],
                [txt.totalWithDown, `${formatNumber(result.totalPayment + result.initialPayment)} ${txt.currency}`]
            ]
        });

        /* ================= CONDITIONS ================= */
        let y = doc.lastAutoTable.finalY + 10;
        
        doc.setFillColor(248, 249, 250);
        doc.rect(20, y, 170, 32, 'F');
        
        doc.setFillColor(26, 58, 82);
        doc.rect(20, y, 3, 32, 'F');
        
        doc.setTextColor(26, 58, 82);
        doc.setFontSize(11);
        doc.text(txt.conditions, 28, y + 7);
        
        doc.setFontSize(8);
        doc.setTextColor(80, 80, 80);
        
        const conds1 = [txt.cond1, txt.cond2, txt.cond3, txt.cond4];
        const conds2 = [txt.cond5, txt.cond6, txt.cond7, txt.cond8];
        
        let condY = y + 13;
        conds1.forEach(c => { doc.text('• ' + c, 28, condY); condY += 5; });
        
        condY = y + 13;
        conds2.forEach(c => { doc.text('• ' + c, 110, condY); condY += 5; });

        /* ================= PAGE 2 - SCHEDULE ================= */
        doc.addPage();

        doc.setFillColor(26, 58, 82);
        doc.rect(0, 0, 210, 18, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.text('FAW TRUCKS', 20, 12);
        
        doc.setFontSize(10);
        doc.text(txt.scheduleTitle, 190, 12, { align: 'right' });

        doc.setTextColor(26, 58, 82);
        doc.setFontSize(14);
        doc.text(txt.scheduleTitle, 105, 28, { align: 'center' });
        
        doc.setFontSize(9);
        doc.setTextColor(128, 128, 128);
        doc.text(`${txt.term}: ${term} ${txt.months} | ${txt.rate}: ${(result.annualRate * 100).toFixed(1)}%`, 105, 34, { align: 'center' });

        /* ================= SCHEDULE TABLE ================= */
        const totalPrincipal = schedule.reduce((s, p) => s + p.principalPayment, 0);
        const totalInterest = schedule.reduce((s, p) => s + p.interestPayment, 0);

        doc.autoTable({
            startY: 40,
            theme: 'grid',
            styles: { 
                fontSize: 8, 
                cellPadding: 2,
                font: 'Roboto',
                halign: 'right'
            },
            headStyles: {
                fillColor: [26, 58, 82],
                textColor: 255,
                halign: 'center'
            },
            columnStyles: {
                0: { halign: 'center', cellWidth: 12 }
            },
            head: [['#', txt.principal, txt.interest, txt.payment, txt.balance]],
            body: [
                ...schedule.map(p => [
                    p.month,
                    formatNumber(p.principalPayment),
                    formatNumber(p.interestPayment),
                    formatNumber(p.monthlyPayment),
                    formatNumber(p.remainingDebt)
                ]),
                // Итоговая строка
                [
                    { content: txt.total, styles: { fillColor: [26, 58, 82], textColor: 255, fontStyle: 'bold', halign: 'center' } },
                    { content: formatNumber(totalPrincipal), styles: { fillColor: [26, 58, 82], textColor: 255, fontStyle: 'bold' } },
                    { content: formatNumber(totalInterest), styles: { fillColor: [26, 58, 82], textColor: 255, fontStyle: 'bold' } },
                    { content: formatNumber(result.totalPayment), styles: { fillColor: [26, 58, 82], textColor: 255, fontStyle: 'bold' } },
                    { content: '0', styles: { fillColor: [26, 58, 82], textColor: 255, fontStyle: 'bold' } }
                ]
            ],
            didParseCell: function(data) {
                if (data.row.index === schedule.length - 1 && data.row.section === 'body') {
                    data.cell.styles.fillColor = [232, 244, 253];
                }
            }
        });

        /* ================= WARNING ================= */
        const warnY = doc.lastAutoTable.finalY + 8;
        
        doc.setFillColor(255, 243, 205);
        doc.rect(20, warnY, 170, 12, 'F');
        
        doc.setFillColor(255, 193, 7);
        doc.rect(20, warnY, 3, 12, 'F');
        
        doc.setTextColor(133, 100, 4);
        doc.setFontSize(8);
        doc.text(`${txt.warning} ${txt.warningText}`, 28, warnY + 7);

        /* ================= FOOTER ================= */
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            
            doc.setFillColor(26, 58, 82);
            doc.rect(0, 287, 210, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text(
                `VUM/FAW TRUCKS | faw.uz | +998 (55) 508-60-60 | ${txt.page} ${i}/${pageCount}`,
                105, 293, { align: 'center' }
            );
        }

        /* ================= SAVE ================= */
        doc.save(`FAW-Lizing-${term}m-${Date.now()}.pdf`);
        console.log('✅ PDF generated successfully');

    } catch (err) {
        console.error('❌ PDF generation error:', err);
        alert('Ошибка при создании PDF. Попробуйте ещё раз.');
    }
}

    // Инициализация при загрузке DOM или сразу если он уже загружен
    if (document.readyState === 'loading') {
        console.log('DOM loading, attaching DOMContentLoaded listener');
        document.addEventListener('DOMContentLoaded', initLizingModal);
    } else {
        console.log('DOM already loaded, initializing immediately');
        initLizingModal();
    }
</script>
</body>
</html>
