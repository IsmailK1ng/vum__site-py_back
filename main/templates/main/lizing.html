{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <title>Faw Trucks O'zbekistonda</title>
    <meta name="description" content="Faw Trucks O'zbekistonda">
    <meta name="keywords" content="Faw Trucks O'zbekistonda">
    <meta name="author" content="mix_design">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Фавикон и иконки -->
    <link rel="shortcut icon" href="{% static 'images/icon/favicon_5.ico' %}" type="image/x-icon" />
    <link rel="apple-touch-icon" href="{% static 'images/icon/_iiiiapple.png' %}" />
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'images/icon/_iiii176.png' %}" />
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icon/_iiii1156.png' %}" />
    <link rel="apple-touch-startup-image" href="{% static 'images/icon/_iiii1.png' %}" />

    <!-- Мета для Facebook -->
    <meta property="og:image:height" content="1200">
    <meta property="og:image:width" content="1200">
    <meta property="og:title" content="Faw Trucks в Узбекистане">
    <meta property="og:description" content="Faw Trucks в Узбекистане">
    <meta property="og:url" content="https://mixdesign.dev/themeforest/rayo">
    <meta property="og:image" content="https://mixdesign.dev/themeforest/rayo/img/og-image.jpg">

    <!-- Подключение стилей -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/loaders/loader.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/plugins.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/main_site.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_main.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_lizing.css' %}">

    <!-- Цвет браузера -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FAF7F6">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#161616">
    <meta name="msapplication-navbutton-color" content="#161616">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <!-- Меню и шапка -->
    {% include 'main/includes/header.html' %}
    <!-- шапка конец -->
    <!-- Контент страницы -->
    <main id="mxd-page-content" class="mxd-page-content">
        <div aria-label="breadcrumb">
            <ol class="breadcrumb-ol">
                <li><a href="{% url 'home' %}">Bosh sahifa</a></li>
                <li class="active"><a href="{% url 'lizing' %}">Lizing</a></li>
            </ol>
        </div>
        <!-- Баннер -->
        <!-- Hero Section Start -->
        <div class="mxd-section">
            <div class="mxd-hero-09">
                <div class="mxd-hero-09__wrap loading-wrap lizing__hero-cont">
                    <div class="mxd-hero-09__headline">
                        <div class="hero-09-headline__caption loading__item">
                            <h2>VUM LIZING</h2>
                            <p class="mxd-hero-09__desc">
                                VUM Lizing orqali siz o'zingizga kerakli FAW yuk
                                mashinasini sotib olishingiz mumkin. Bizning lizing shartlarimiz moslashuvchan bo'lib,
                                sizning biznesingiz ehtiyojlariga mos keladi.
                            </p>
                        </div>
                    </div>
                    <div class="mxd-hero-09__objects">
                        <div class="hero-09-objects__image loading__item">
                            <img class="mxd-move" src="{% static 'images/lizing.png' %}" alt="Hero Image">
                        </div>
                        <div class="hero-09-objects__item item-01 loading__item">
                            <div class="mxd-counter horizontal">
                                <p id="stats-counter-1" class="mxd-counter__number mxd-stats-number xsmall">0</p>
                                <p class="mxd-counter__descr t-140 t-bright t-small">Yil<br>bozorda</p>
                            </div>
                        </div>
                        <div class="hero-09-objects__item item-02 loading__item">
                            <div class="mxd-counter horizontal">
                                <span class="mark-text">Minimal dastlabki to'lov - 30%</span>
                            </div>
                        </div>
                        <div class="hero-09-objects__item item-03 loading__item">
                            <div class="mxd-hero__mark">
                                <span class="mark-icon"></span>
                                <span class="mark-text">Tez rasmiylashtirish</span>
                            </div>
                        </div>
                    </div>
                    <div class="lizing-calc__title">
                        <h2 class="calc-title">Lizing kalkulatori</h2>
                    </div>
                </div>
            </div>
        </div>
        <!-- Hero Section End -->
        <!-- ЛИЗИНГОВЫЙ КАЛЬКУЛЯТОР -->
        <div class="mxd-section">
            <div class="mxd-hero-06">
                <div class="mxd-hero-06__wrap loading-wrap">
                    <div class="mxd-hero-06__top">
                        <div class="mxd-hero-06__content">
                            <div class="lizing-calc-container">
                                <div class="lizing-form-section">
                                    <div class="lizing-form-group">
                                        <label>Texnika narxi</label>
                                        <input type="text" class="lizing-input-field" id="amountInput"
                                            value="300 000 000 so'm">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="amountSlider" min="250000000"
                                                max="600000000" value="300000000" step="1000000">
                                            <div class="lizing-slider-labels">
                                                <span>250 mln. so'm</span>
                                                <span>400 mln. so'm</span>
                                                <span>600 mln. so'm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="lizing-form-group">
                                        <label>Dastlabki to'lov</label>
                                        <input type="text" class="lizing-input-field" id="downPaymentInput"
                                            value="120 000 000 so'm">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="downPaymentSlider" min="30"
                                                max="60" value="40" step="1">
                                            <div class="lizing-slider-labels">
                                                <span>30%</span>
                                                <span>45%</span>
                                                <span>60%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="lizing-form-group">
                                        <label>Lizing muddati</label>
                                        <input type="text" class="lizing-input-field" id="termInput" value="24 oy">
                                        <div class="lizing-slider-container">
                                            <input type="range" class="lizing-slider" id="termSlider" min="12" max="60"
                                                value="24" step="1">
                                            <div class="lizing-slider-labels">
                                                <span>12 oy</span>
                                                <span>33 oy</span>
                                                <span>60 oy</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="lizing-result-section">
                                    <div class="lizing-result-amount">Moliyalashtirish summasi</div>
                                    <div class="lizing-result-value" id="financeAmount">180 900 000 so'm</div>
                                    <div class="lizing-payment-info">
                                        <div>
                                            <div class="lizing-monthly-label">Oylik to'lov</div>
                                            <div class="lizing-monthly-value" id="monthlyPayment">8 625 000 so'mdan
                                            </div>
                                        </div>
                                        <div>
                                            <div class="lizing-monthly-label">Dastlabki to'lov <span
                                                    class="lizing-info-icon">?</span></div>
                                            <div class="lizing-payment-value" id="downPaymentAmount">40%</div>
                                        </div>
                                    </div>
                                    <div class="lizing-document-section">
                                        <div class="lizing-document-label">Kerakli hujjatlar <span
                                                class="lizing-info-icon">?</span></div>
                                        <button class="lizing-document-btn">Pasport</button>
                                        <button class="lizing-document-btn">Daromad haqida ma'lumotnoma</button>
                                    </div>
                                    <div class="lizing-calculation-info">
                                        <div class="lizing-calculation-label">Hisob-kitob dastlabki <span
                                                class="lizing-info-icon">?</span></div>
                                    </div>
                                    <div class="lizing-buttons">
                                        <button class="lizing-btn-primary">Ariza yuborish</button>
                                        <button type="button" class="lizing-btn-secondary" id="detailsBtn">Lizing haqida
                                            batafsil</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Футер -->
    {% include 'main/includes/footer.html' %}

    <!-- Кнопка вверх -->
    <a href="#0" id="to-top" class="btn btn-to-top slide-up anim-no-delay">
        <i class="ph ph-arrow-up"></i>
    </a>

    <!-- МОДАЛЬНОЕ ОКНО КАЛЬКУЛЯТОРА -->
    <div id="detailsModal" class="modal">
        <div class="modal-wrapper">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Lizing haqida batafsil ma'lumot</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="calculation-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Texnika narxi</div>
                                <div class="summary-value" id="modal-car-price">300 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Dastlabki to'lov</div>
                                <div class="summary-value" id="modal-initial-payment">120 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Lizing muddati</div>
                                <div class="summary-value" id="modal-term">24 oy</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Oylik to'lov</div>
                                <div class="summary-value primary" id="modal-monthly-payment">8 625 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Jami to'lov</div>
                                <div class="summary-value" id="modal-total-payment">207 000 000 so'm</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Foiz stavkasi</div>
                                <div class="summary-value" id="modal-rate">22%</div>
                            </div>
                        </div>
                    </div>

                    <div class="payment-schedule">
                        <h3 class="schedule-title">To'lov jadvali</h3>
                        <div class="schedule-table-wrapper">
                            <table class="schedule-table">
                                <thead>
                                    <tr>
                                        <th>Oy</th>
                                        <th>Asosiy qarz</th>
                                        <th>Foizlar</th>
                                        <th>Oylik to'lov</th>
                                        <th>Qoldiq</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-tbody">
                                    <!-- JavaScript tomonidan to'ldiriladi -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="conditions-section">
                        <h3 class="conditions-title">Lizing shartlari</h3>
                        <ul class="conditions-list">
                            <li>Minimal dastlabki to'lov - 30%</li>
                            <li>Maksimal lizing muddati - 60 oy</li>
                            <li>Texnikaning har qanday holatda bo'lishi mumkin</li>
                            <li>Kredit tarixisiz ham rasm qilish mumkin</li>
                            <li>Tez rasmiylashtirish (1-2 kun)</li>
                            <li>Muddatdan oldin to'lash imkoniyati</li>
                            <li>Lizing tugagandan keyin texnika sizniki bo'ladi</li>
                            <li>Kasko sug'urta majburiy</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение скриптов -->
    <script src="{% static 'js/libs.min.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'js/faw.js' %}"></script>

    <!-- Скролл скрипт -->
    <script>
        (function () {
            function getHeaderHeight() {
                try { var h = document.getElementById('header'); return h ? h.offsetHeight || 0 : 0; } catch (e) { return 0; }
            }

            function scrollToElementById(id) {
                var el = document.getElementById(id);
                if (!el) return;
                var headerH = getHeaderHeight();
                var offset = 18;
                var rect = el.getBoundingClientRect();
                var targetY = Math.max(0, Math.round(window.pageYOffset + rect.top - headerH - offset));
                try { window.scrollTo({ top: targetY, behavior: 'smooth' }); }
                catch (e) { window.scrollTo(0, targetY); }
            }

            document.addEventListener('click', function (e) {
                var a = e.target.closest && e.target.closest('a[href^="#"]');
                if (!a) return;
                var href = a.getAttribute('href');
                if (!href || href === '#') return;
                var id = href.slice(1);
                if (!id) return;
                if (document.getElementById(id)) {
                    e.preventDefault();
                    scrollToElementById(id);
                }
            }, false);
        })();
    </script>

    <!-- ЛИЗИНГОВЫЙ КАЛЬКУЛЯТОР СКРИПТ -->
    <script>
        const amountSlider = document.getElementById('amountSlider');
        const downPaymentSlider = document.getElementById('downPaymentSlider');
        const termSlider = document.getElementById('termSlider');
        const amountInput = document.getElementById('amountInput');
        const downPaymentInput = document.getElementById('downPaymentInput');
        const termInput = document.getElementById('termInput');
        const financeAmount = document.getElementById('financeAmount');
        const monthlyPayment = document.getElementById('monthlyPayment');
        const downPaymentAmount = document.getElementById('downPaymentAmount');

        let updatingFromSlider = false;
        let updatingFromInput = false;

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num);
        }

        function parseAmount(text) {
            return parseInt(text.replace(/[^\d]/g, '')) || 0;
        }

        function parseTerm(text) {
            return parseInt(text.replace(/[^\d]/g, '')) || 0;
        }

        const AMOUNT_MIN = 250000000;
        const AMOUNT_MAX = 600000000;
        const DOWNPAY_MIN = 30;
        const DOWNPAY_MAX = 60;
        const TERM_MIN = 12;
        const TERM_MAX = 60;

        function calculateLeasing(carPrice, initialPaymentPercent, termInMonths) {
            let annualRate;
            if (termInMonths <= 24) {
                annualRate = 0.22;
            } else if (termInMonths <= 36) {
                annualRate = 0.23;
            } else if (termInMonths <= 48) {
                annualRate = 0.26;
            } else if (termInMonths <= 60) {
                annualRate = 0.265;
            } else {
                annualRate = 0.265;
            }

            const initialPayment = Math.round(carPrice * initialPaymentPercent / 100);
            const financingBase = carPrice - initialPayment;
            const additionalCosts = Math.round(financingBase * 0.005);
            const totalAmount = financingBase + additionalCosts;

            const monthlyRate = annualRate / 12;
            const annuityCoefficient = (monthlyRate * Math.pow(1 + monthlyRate, termInMonths)) / (Math.pow(1 + monthlyRate, termInMonths) - 1);
            const monthlyPayment = Math.round(totalAmount * annuityCoefficient);

            return {
                carPrice,
                initialPayment,
                financingBase,
                totalAmount,
                monthlyPayment,
                totalPayment: monthlyPayment * termInMonths,
                annualRate,
                termInMonths
            };
        }

        function generatePaymentSchedule(totalAmount, monthlyPayment, annualRate, termInMonths) {
            const schedule = [];
            let remainingDebt = totalAmount;
            const monthlyRate = annualRate / 12;

            for (let month = 1; month <= termInMonths; month++) {
                const interestPayment = Math.round(remainingDebt * monthlyRate);
                const principalPayment = monthlyPayment - interestPayment;
                remainingDebt = Math.max(0, remainingDebt - principalPayment);

                schedule.push({
                    month,
                    principalPayment,
                    interestPayment,
                    monthlyPayment,
                    remainingDebt
                });
            }

            return schedule;
        }

        function updateFromSliders() {
            if (updatingFromInput) return;
            updatingFromSlider = true;

            const amount = parseInt(amountSlider.value);
            const downPaymentPercent = parseInt(downPaymentSlider.value);
            const term = parseInt(termSlider.value);
            const downPaymentSum = Math.round(amount * downPaymentPercent / 100);

            amountInput.value = `${formatNumber(amount)} so'm`;
            downPaymentInput.value = `${formatNumber(downPaymentSum)} so'm`;
            termInput.value = `${term} oy`;

            updateResults();
            updateSliderBackgrounds();
            updatingFromSlider = false;
        }

        function updateResults() {
            const amount = parseInt(amountSlider.value);
            const downPaymentPercent = parseInt(downPaymentSlider.value);
            const term = parseInt(termSlider.value);
            const result = calculateLeasing(amount, downPaymentPercent, term);

            financeAmount.textContent = `${formatNumber(result.totalAmount)} so'm`;
            monthlyPayment.textContent = `${formatNumber(result.monthlyPayment)} so'mdan`;
            downPaymentAmount.textContent = `${downPaymentPercent}%`;
        }

        function updateSliderBackground(slider) {
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const value = parseFloat(slider.value);
            const percentage = ((value - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, black 0%, grey ${percentage}%, var(--base-shade) ${percentage}%, var(--base-shade) 100%)`;
        }

        function updateSliderBackgrounds() {
            updateSliderBackground(amountSlider);
            updateSliderBackground(downPaymentSlider);
            updateSliderBackground(termSlider);
        }

        // Обработчики слайдеров
        amountSlider.addEventListener('input', updateFromSliders);
        downPaymentSlider.addEventListener('input', updateFromSliders);
        termSlider.addEventListener('input', updateFromSliders);

        // Обработчики полей ввода
        amountInput.addEventListener('blur', function () {
            if (updatingFromSlider) return;
            updatingFromInput = true;
            const value = parseAmount(this.value);
            const clampedValue = Math.max(AMOUNT_MIN, Math.min(AMOUNT_MAX, value));
            amountSlider.value = clampedValue;
            this.value = `${formatNumber(clampedValue)} so'm`;
            const downPaymentPercent = parseInt(downPaymentSlider.value);
            const newDownPayment = Math.round(clampedValue * downPaymentPercent / 100);
            downPaymentInput.value = `${formatNumber(newDownPayment)} so'm`;
            updateResults();
            updateSliderBackgrounds();
            updatingFromInput = false;
        });

        downPaymentInput.addEventListener('blur', function () {
            if (updatingFromSlider) return;
            updatingFromInput = true;
            const value = parseAmount(this.value);
            const amount = parseInt(amountSlider.value);
            let percent = Math.round((value / amount) * 100);
            percent = Math.max(DOWNPAY_MIN, Math.min(DOWNPAY_MAX, percent));
            downPaymentSlider.value = percent;
            const exactDownPayment = Math.round(amount * percent / 100);
            this.value = `${formatNumber(exactDownPayment)} so'm`;
            updateResults();
            updateSliderBackgrounds();
            updatingFromInput = false;
        });

        termInput.addEventListener('blur', function () {
            if (updatingFromSlider) return;
            updatingFromInput = true;
            const value = parseTerm(this.value);
            const clampedValue = Math.max(TERM_MIN, Math.min(TERM_MAX, value));
            termSlider.value = clampedValue;
            this.value = `${clampedValue} oy`;
            updateResults();
            updateSliderBackgrounds();
            updatingFromInput = false;
        });

        // Обработчики фокуса
        amountInput.addEventListener('focus', function () {
            if (updatingFromSlider) return;
            const value = parseAmount(this.value);
            this.value = value.toString();
        });

        downPaymentInput.addEventListener('focus', function () {
            if (updatingFromSlider) return;
            const value = parseAmount(this.value);
            this.value = value.toString();
        });

        termInput.addEventListener('focus', function () {
            if (updatingFromSlider) return;
            const value = parseTerm(this.value);
            this.value = value.toString();
        });

        // Модальное окно
        const modal = document.getElementById('detailsModal');
        const detailsBtn = document.getElementById('detailsBtn');
        const closeBtn = document.querySelector('.close');

        // Исправление скролла колесиком мыши в модальном окне
        function fixModalScroll() {
            const modalWrapper = document.querySelector('.modal-wrapper');
            const modal = document.getElementById('detailsModal');

            if (modalWrapper && modal) {
                // Предотвращаем всплытие события wheel
                modalWrapper.addEventListener('wheel', function (e) {
                    e.stopPropagation();
                }, { passive: false });

                // Альтернативный вариант - перехват на самом модальном окне
                modal.addEventListener('wheel', function (e) {
                    if (e.target.closest('.modal-wrapper')) {
                        const wrapper = e.target.closest('.modal-wrapper');
                        const scrollTop = wrapper.scrollTop;
                        const scrollHeight = wrapper.scrollHeight;
                        const height = wrapper.clientHeight;
                        const wheelDelta = e.deltaY;
                        const scrollDown = wheelDelta > 0;

                        // Разрешаем скролл только если есть куда скроллить
                        if (scrollDown && scrollTop + height >= scrollHeight) {
                            e.preventDefault();
                        } else if (!scrollDown && scrollTop <= 0) {
                            e.preventDefault();
                        } else {
                            e.stopPropagation();
                        }
                    }
                }, { passive: false });
            }
        }

        function showModal() {
            const amount = parseInt(amountSlider.value);
            const downPaymentPercent = parseInt(downPaymentSlider.value);
            const term = parseInt(termSlider.value);
            const result = calculateLeasing(amount, downPaymentPercent, term);

            document.getElementById('modal-car-price').textContent = `${formatNumber(result.carPrice)} so'm`;
            document.getElementById('modal-initial-payment').textContent = `${formatNumber(result.initialPayment)} so'm`;
            document.getElementById('modal-term').textContent = `${term} oy`;
            document.getElementById('modal-monthly-payment').textContent = `${formatNumber(result.monthlyPayment)} so'm`;
            document.getElementById('modal-total-payment').textContent = `${formatNumber(result.totalPayment)} so'm`;
            document.getElementById('modal-rate').textContent = `${(result.annualRate * 100).toFixed(1)}%`;

            const schedule = generatePaymentSchedule(result.totalAmount, result.monthlyPayment, result.annualRate, term);
            const tbody = document.getElementById('schedule-tbody');
            tbody.innerHTML = '';

            schedule.forEach(payment => {
                const row = tbody.insertRow();
                row.innerHTML = `
            <td>${payment.month}</td>
            <td>${formatNumber(payment.principalPayment)} so'm</td>
            <td>${formatNumber(payment.interestPayment)} so'm</td>
            <td>${formatNumber(payment.monthlyPayment)} so'm</td>
            <td>${formatNumber(payment.remainingDebt)} so'm</td>
        `;
            });

            modal.classList.add('show');
            document.body.classList.add('modal-open');

            // Исправляем скролл колесиком
            fixModalScroll();

            modal.focus();
        }

        function hideModal() {
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        detailsBtn.addEventListener('click', function (event) {
            event.preventDefault();
            showModal();
        });
        closeBtn.addEventListener('click', hideModal);
        window.addEventListener('click', function (event) {
            if (event.target === modal || event.target.classList.contains('modal-wrapper')) {
                hideModal();
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                hideModal();
            }
        });
        // Интеграция с переключателем темы
        const themeToggle = document.getElementById('color-switcher');
        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateSliderBackgrounds();
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
            }
        }
        // Инициализация
        updateFromSliders();
    </script>

</body>

</html>