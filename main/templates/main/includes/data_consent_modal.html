<!-- Data Consent Modal / Модальное окно подтверждения обработки данных -->
<div id="data-consent-modal" class="data-consent-modal">
    <div class="data-consent-modal__overlay"></div>
    <div class="data-consent-modal__content">
        <button class="data-consent-modal__close" aria-label="Закрыть">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>

        <div class="data-consent-modal__header">
            <h2 class="data-consent-modal__title">
                {% if LANGUAGE_CODE == 'ru' %}Подтверждение обработки данных
                {% elif LANGUAGE_CODE == 'en' %}Data Processing Confirmation
                {% else %}Ma'lumotlarni qayta ishlash tasdig'i{% endif %}
            </h2>
        </div>

        <div class="data-consent-modal__body">
            <div class="data-consent-modal__text">
                {% if LANGUAGE_CODE == 'ru' %}
                <p>Я даю согласие на обработку моих персональных данных в соответствии с <a href="#" class="consent-link">Политикой конфиденциальности</a> компании.</p>
                <p>Мои персональные данные будут использованы исключительно для:</p>
                <ul>
                    <li>Ответа на мой запрос</li>
                    <li>Предоставления информации о продуктах и услугах</li>
                    <li>Связи со мной в указанном контакте</li>
                </ul>
                <p>Я понимаю, что имею право отозвать свое согласие в любое время путем написания на электронный адрес компании.</p>
                {% elif LANGUAGE_CODE == 'en' %}
                <p>I consent to the processing of my personal data in accordance with the company's <a href="#" class="consent-link">Privacy Policy</a>.</p>
                <p>My personal data will be used exclusively for:</p>
                <ul>
                    <li>Responding to my request</li>
                    <li>Providing information about products and services</li>
                    <li>Contacting me at the specified contact</li>
                </ul>
                <p>I understand that I have the right to withdraw my consent at any time by writing to the company's email address.</p>
                {% else %}
                <p>Men o'z shaxsiy ma'lumotlarimning <a href="#" class="consent-link">Maxfiylik siyosati</a> ga muvofiq qayta ishlashga rozilik beraman.</p>
                <p>Mening shaxsiy ma'lumotlarim faqat quyidagilar uchun ishlatiladi:</p>
                <ul>
                    <li>Mening so'rovimga javob berish</li>
                    <li>Mahsulotlar va xizmatlar haqida ma'lumot berish</li>
                    <li>Belgilangan aloqa orqali men bilan bog'lanish</li>
                </ul>
                <p>Men har qanday vaqtda kompaniyaning elektron pochtasiga yozib, rozilikni bekor qila olamanligini tushunaman.</p>
                {% endif %}
            </div>

            <div class="data-consent-modal__checkbox">
                <label class="consent-checkbox">
                    <input type="checkbox" id="consent-checkbox" class="consent-checkbox__input">
                    <span class="consent-checkbox__label">
                        {% if LANGUAGE_CODE == 'ru' %}Я согласен с обработкой моих персональных данных
                        {% elif LANGUAGE_CODE == 'en' %}I agree to the processing of my personal data
                        {% else %}Men shaxsiy ma'lumotlarning qayta ishlashiga rozilik beraman{% endif %}
                    </span>
                </label>
            </div>
        </div>

        <div class="data-consent-modal__footer">
            <button class="data-consent-modal__btn-cancel" id="consent-cancel">
                {% if LANGUAGE_CODE == 'ru' %}Отмена
                {% elif LANGUAGE_CODE == 'en' %}Cancel
                {% else %}Bekor qilish{% endif %}
            </button>
            <button class="data-consent-modal__btn-confirm" id="consent-confirm" disabled>
                <span class="consent-confirm-text">
                    {% if LANGUAGE_CODE == 'ru' %}Принять
                    {% elif LANGUAGE_CODE == 'en' %}Accept
                    {% else %}Qabul qilish{% endif %}
                </span>
                <span class="consent-confirm-loader" style="display: none;">
                    <span class="loader-spinner"></span>
                </span>
            </button>
        </div>
    </div>
</div>

<style>
    .data-consent-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .data-consent-modal.active {
        display: flex;
    }

    .data-consent-modal__overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        cursor: pointer;
    }

    .data-consent-modal__content {
        position: relative;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 32px 24px;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .data-consent-modal__close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        cursor: pointer;
        color: #333;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s;
    }

    .data-consent-modal__close:hover {
        color: #d32f2f;
    }

    .data-consent-modal__header {
        margin-bottom: 24px;
        padding-right: 24px;
    }

    .data-consent-modal__title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        color: #333;
    }

    .data-consent-modal__body {
        margin-bottom: 24px;
    }

    .data-consent-modal__text {
        font-size: 14px;
        line-height: 1.6;
        color: #666;
        margin-bottom: 20px;
    }

    .data-consent-modal__text p {
        margin: 12px 0;
    }

    .data-consent-modal__text ul {
        margin: 12px 0 12px 20px;
        padding: 0;
        list-style: disc;
    }

    .data-consent-modal__text ul li {
        margin: 8px 0;
    }

    .consent-link {
        color: #1976d2;
        text-decoration: none;
        transition: color 0.3s;
    }

    .consent-link:hover {
        color: #1565c0;
        text-decoration: underline;
    }

    .consent-checkbox {
        display: flex;
        align-items: flex-start;
        cursor: pointer;
        user-select: none;
    }

    .consent-checkbox__input {
        margin-right: 12px;
        margin-top: 2px;
        cursor: pointer;
        width: 18px;
        height: 18px;
        min-width: 18px;
    }

    .consent-checkbox__label {
        font-size: 14px;
        color: #333;
        font-weight: 500;
        line-height: 1.4;
    }

    .data-consent-modal__footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .data-consent-modal__btn-cancel,
    .data-consent-modal__btn-confirm {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .data-consent-modal__btn-cancel {
        background: #f0f0f0;
        color: #333;
    }

    .data-consent-modal__btn-cancel:hover {
        background: #e0e0e0;
    }

    .data-consent-modal__btn-confirm {
        background: #1976d2;
        color: white;
    }

    .data-consent-modal__btn-confirm:hover:not(:disabled) {
        background: #1565c0;
    }

    .data-consent-modal__btn-confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .consent-confirm-loader {
        display: inline-flex;
        align-items: center;
        margin-left: 8px;
    }

    .loader-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Mobile */
    @media (max-width: 600px) {
        .data-consent-modal__content {
            width: 95%;
            padding: 24px 16px;
        }

        .data-consent-modal__header {
            padding-right: 16px;
        }

        .data-consent-modal__title {
            font-size: 18px;
        }

        .data-consent-modal__footer {
            flex-direction: column-reverse;
        }

        .data-consent-modal__btn-cancel,
        .data-consent-modal__btn-confirm {
            width: 100%;
        }
    }
</style>

<script>
    // Управление модальным окном подтверждения обработки данных
    class DataConsentModal {
        constructor() {
            this.modal = document.getElementById('data-consent-modal');
            this.overlay = this.modal.querySelector('.data-consent-modal__overlay');
            this.closeBtn = this.modal.querySelector('.data-consent-modal__close');
            this.confirmBtn = this.modal.querySelector('#consent-confirm');
            this.cancelBtn = this.modal.querySelector('#consent-cancel');
            this.checkbox = this.modal.querySelector('#consent-checkbox');
            this.formToSubmit = null;

            this.init();
        }

        init() {
            this.checkbox.addEventListener('change', () => this.updateConfirmButton());
            this.closeBtn.addEventListener('click', () => this.close());
            this.overlay.addEventListener('click', () => this.close());
            this.confirmBtn.addEventListener('click', () => this.confirm());
            this.cancelBtn.addEventListener('click', () => this.close());
        }

        updateConfirmButton() {
            this.confirmBtn.disabled = !this.checkbox.checked;
        }

        open(formElement) {
            this.formToSubmit = formElement;
            this.checkbox.checked = false;
            this.updateConfirmButton();
            this.modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        close() {
            this.modal.classList.remove('active');
            document.body.style.overflow = '';
            this.formToSubmit = null;
        }

        confirm() {
            if (this.formToSubmit && this.checkbox.checked) {
                // Сохраняем согласие в sessionStorage
                sessionStorage.setItem('consent-given', 'true');
                
                // Показываем спиннер загрузки
                const confirmText = this.confirmBtn.querySelector('.consent-confirm-text');
                const confirmLoader = this.confirmBtn.querySelector('.consent-confirm-loader');
                if (confirmText && confirmLoader) {
                    confirmText.style.display = 'none';
                    confirmLoader.style.display = 'inline-flex';
                }
                
                // Отключаем кнопку во время отправки
                this.confirmBtn.disabled = true;
                this.cancelBtn.disabled = true;
                
                // Закрываем модаль ИММЕДИАТно
                setTimeout(() => {
                    this.close();
                }, 100);
                
                // Определяем функцию отправки для данной формы
                const formId = this.formToSubmit.id;
                let submitFunc = null;
                
                if (formId === 'contactForm') {
                    submitFunc = window.submitContactForm;
                } else if (formId === 'faw-contact-form') {
                    submitFunc = window.submitProductContactForm;
                } else if (formId === 'lizing-contact-form') {
                    submitFunc = window.submitLizingForm;
                } else if (formId === 'dealer-form') {
                    submitFunc = window.submitDealerForm;
                }
                
                // Отправляем форму СРАЗУ (без задержек)
                if (submitFunc && typeof submitFunc === 'function') {
                    submitFunc(this.formToSubmit);
                } else if (this.formToSubmit.submit) {
                    this.formToSubmit.submit();
                } else {
                    this.formToSubmit.dispatchEvent(new Event('submit'));
                }
            }
        }
    }

    // Инициализируем модальное окно при загрузке DOM
    let consentModal;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            consentModal = new DataConsentModal();
        });
    } else {
        consentModal = new DataConsentModal();
    }

    // Функция для показа модального окна перед отправкой формы
    function showConsentBeforeSubmit(event, formElement) {
        event.preventDefault();
        
        // Проверяем, было ли уже дано согласие в этой сессии
        if (sessionStorage.getItem('consent-given') === 'true') {
            const formId = formElement.id;
            let submitFunc = null;
            
            if (formId === 'contactForm') {
                submitFunc = window.submitContactForm;
            } else if (formId === 'faw-contact-form') {
                submitFunc = window.submitProductContactForm;
            } else if (formId === 'lizing-contact-form') {
                submitFunc = window.submitLizingForm;
            } else if (formId === 'dealer-form') {
                submitFunc = window.submitDealerForm;
            }
            
            if (submitFunc && typeof submitFunc === 'function') {
                submitFunc(formElement);
            } else {
                formElement.submit();
            }
        } else {
            consentModal.open(formElement);
        }
    }
</script>
