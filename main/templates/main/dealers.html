{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">

    <!-- Page Title -->
    <title>VUM dilerlar</title>

    <!-- Meta Tags -->
    <meta name="description" content="Faw Trucks –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ">
    <meta name="keywords" content="Faw Trucks –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ">
    <meta name="author" content="mix_design">

    <!-- Viewport Meta-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- Template Favicon & Icons Start -->
    <link rel="shortcut icon" href="{% static 'images/icon/favicon_5.ico' %}" type="image/x-icon" />
    <link rel="apple-touch-icon" href="{% static 'images/icon/_iiiiapple.png' %}" />
    <link rel="apple-touch-icon" sizes="76x76" href="{% static 'images/icon/_iiii176.png' %}" />
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icon/_iiii1156.png' %}" />
    <link rel="apple-touch-startup-image" href="{% static 'images/icon/_iiii1.png' %}" />
    <!-- Template Favicon & Icons End -->

    <!-- Facebook Metadata Start -->
    <meta property="og:image:height" content="1200">
    <meta property="og:image:width" content="1200">
    <meta property="og:title" content="Faw Trucks –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ">
    <meta property="og:description" content="Faw Trucks –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ">
    <meta property="og:url" content="https://mixdesign.dev/themeforest/rayo">
    <meta property="og:image" content="https://mixdesign.dev/themeforest/rayo/img/og-image.jpg">
    <!-- Facebook Metadata End -->

    <!-- Template Styles Start -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/loaders/loader.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/plugins.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/main_site.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_main.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/breadcrumbs.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/site_dealers.css' %}">


    <!-- Template Styles End -->

    <!-- Custom Browser Color Start -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FAF7F6">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#161616">
    <meta name="msapplication-navbutton-color" content="#161616">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Custom Browser Color End -->

</head>

<body>

    <!-- Loader Start -->
    <div id="loader" style="display: none;" class="loader">
        <div class="loader__wrapper">
            <div class="loader__content">
                <div class="loader__count">
                    <span class="count__text">0</span>
                    <!-- <span class="count__percent">%</span> -->
                </div>
            </div>
        </div>
    </div>
    <!-- Loader End -->
    <!-- –ú–µ–Ω—é –∏ —à–∞–ø–∫–∞ (–Ω–∞—á–∞–ª–æ) -->
    {% include 'main/includes/header.html' %}
    <!-- –ú–µ–Ω—é –∏ —à–∞–ø–∫–∞ (–∫–æ–Ω–µ—Ü) -->
    <div class="mxd-block loading-wrap">
    </div>
    <div class="mxd-block">
        <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
        <div class="mxd-section-filter pre-grid">
            <div class="mxd-section-filter__inner animate-card-3">
                <div class="mxd-grid-item-1">
                    <div class="section-filter">
                        <div aria-label="breadcrumb">
                            <ol class="breadcrumb-ol">
                                <li><a href="{% url 'home' %}">Bosh sahifa</a></li>
                                <li class="active"><a href="{% url 'dealers' %}">Dilerlar</a></li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="faw-history-title fade-in">
        <h2 class="reveal-type anim-uni-in-up">VUM rasmiy dilerlar</h2>
    </div>
    <div class="container">
        <div id="map">
            <div class="map-header">
                <div class="controls">
                    <div class="search-container">
                        <input type="text" id="searchBox" class="search-box"
                            placeholder="Shahar, manzil yoki diler nomi bo'yicha qidirish...">
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active btn-anim" data-service="all">Barcha dilerlar</button>
                        <button class="filter-btn" data-service="Sotuv">Sotuv</button>
                        <button class="filter-btn" data-service="Servis">Servis</button>
                        <button class="filter-btn" data-service="Ehtiyot qismlar">Ehtiyot qismlar</button>
                        <button class="filter-btn" data-service="Maslahatlar">Maslahatlar</button>
                        <button class="filter-btn" data-service="Maslahatlar">Maslahatlar</button>
                        <a href="{% url 'become_a_dealer' %}"><button
                                class="filter-btn btn btn-anim btn-default slide-right-up ">
                                <span class="btn-caption">Diler bo'lish</span>
                                <i class="ph-bold ph-arrow-up-right"></i>
                            </button>
                        </a>
                    </div>
                </div>
            </div>
            <div class="loading" id="mapLoading">
                <div class="spinner"></div>
                <span>Kartani yuklash...</span>
            </div>
            <button class="find-nearest-btn" onclick="findNearestDealer()" title="Eng yaqin dilerni topish">üìç</button>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalDealers">0</div>
                <div class="stat-label">Jami dilerlar</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="visibleDealers">0</div>
                <div class="stat-label">Kartada ko'rsatilgan</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="citiesCount">0</div>
                <div class="stat-label">Qamrov shaharlari</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="servicesCount">0</div>
                <div class="stat-label">Xizmat turlari</div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div id="dealerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Diler haqida ma'lumot</h3>
                <div class="modal-subtitle" id="modalSubtitle"></div>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="dealerInfo" class="dealer-info"></div>
            </div>
        </div>
    </div>

    <!-- –§—É—Ç–µ—Ä (–Ω–∞—á–∞–ª–æ) -->
    {% include 'main/includes/footer.html' %}
    <!-- –§—É—Ç–µ—Ä (–∫–æ–Ω–µ—Ü) -->
    <!-- To Top Button Start -->
    <a href="#0" id="to-top" class="btn btn-to-top slide-up anim-no-delay">
        <i class="ph ph-arrow-up"></i>
    </a>
    <!-- To Top Button End -->

    <!-- Load Scripts Start -->
    <script src="{% static 'js/libs.min.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
    <script src="{% static 'faw-js/faw.js' %}"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç —Å –≤–∞—à–∏–º API –∫–ª—é—á–æ–º -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=145cca7b-9118-4b72-b7b6-261dbc414620&lang=ru_RU"></script>

    <script>
        // ========== –î–ê–ù–ù–´–ï –î–ò–õ–ï–†–û–í ==========
        const dealers = [{
            id: 1, name: "MCHJ ¬´Ideal Truck Sales¬ª", address: "O'zbekiston, Toshkent shahri, Yangi Sergeli ko'chasi, 25-uy. Avtosentr.", coordinates: [41.237360, 69.213242],
            phone: "+998 71 203-10-40", email: "manideal@mail.ru", website: "https://ideal-tehno.uz",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Begzod", city: "Toshkent"
        },
        {
            id: 2, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Toshkent shahri, Yangihayot tumani, Yangi Darxon MFY, Toshkent halqa avtomobil yo ºli ko'chasi, 23-uy",
            coordinates: [41.222225, 69.192259], phone: "+998 91 779-73-73", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Muhriddin", city: "Toshkent"
        },
        {
            id: 3, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Toshkent shahri, Sirg'ali tumani, Qumariq MFY, Qum-Ariq ko'chasi, 24-a-uy",
            coordinates: [41.245010, 69.255868], phone: "+998 90 065-35-35", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Muslim", city: "Toshkent"
        },
        {
            id: 4, name: "MCHJ ¬´MAGISTRAL DIESEL SERVICE¬ª",
            address: "Toshkent viloyati, Zangiota tumani, Erkin QFY Tariq Teshar mahallesi, M39 Avtomagistral yo'li ko'chasi, 54 A-uy",
            coordinates: [41.227780, 69.148816], phone: "+998 99 808-09-90", email: "info@magistral.uz", website: "https://magistral.uz",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Komron", city: "Toshkent viloyati"
        },
        {
            id: 5, name: "MCHJ ¬´MAGISTRAL DIESEL SERVICE¬ª",
            address: "Toshkent viloyati, Zangiota tumani, Erkin QFY Tariq Teshar mahallesi, M39 Avtomagistral yo'li ko'chasi, 54 A-uy",
            coordinates: [41.298308, 69.292843], phone: "+998 99 040-09-90", email: "info@magistral.uz", website: "https://magistral.uz",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Qodirov Zaid", city: "Toshkent viloyati"
        },
        {
            id: 6, name: "MCHJ ¬´DELTA-AUTO MOTORS¬ª",
            address: "Toshkent viloyati, Olmaliq sh. Saxovat mahallasi, Ravnaq ko'chasi",
            coordinates: [40.88795582024242, 69.5780345958458], phone: "+998 99 93 515-09-99", email: "sundj_83@mail.ru",
            website: "https://www.instagram.com/deltaautomotors/",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "", city: "Toshkent"
        },
        {
            id: 7, name: "MCHJ ¬´DELTA-AUTO MOTORS¬ª",
            address: "Toshkent viloyati, Olmaliq sh. Saxovat mahallasi, Ravnaq ko'chasi",
            coordinates: [41.231030, 69.155483], phone: "+998 93 500-77-33", email: "sundj_83@mail.ru",
            website: "https://www.instagram.com/deltaautomotors",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "", city: "Toshkent viloyati"
        },
        {
            id: 8, name: "MCHJ ¬´COMTRANS AUTO SERVICE¬ª",
            address: "Toshkent, Yangihayot tumani, Past Darkhon mahallasi, Navruz ko'chasi 26",
            coordinates: [41.227671, 69.196490], phone: "+998 77-417-00-33", email: "Abdurasul0586@mail.ru",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Nazir", city: "Toshkent"
        },
        {
            id: 9, name: "BBT TRUCKS¬ª",
            address: "Toshkent shahri, Yunusobod tumani XALQABOD MFY, 16 mavzesi, 28a-uy",
            coordinates: [41.367297, 69.327222], phone: "+998 33 711-33-65", email: "azimovbek1993@gmail.com",
            website: "https://www.instagram.com/bbt_trucks",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Nodir", city: "Toshkent"
        },
        {
            id: 10, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Farg'ona viloyat,Farg'ona shahar Ahmad Yassaviy ko'chasi 26",
            coordinates: [40.379887, 71.806633], phone: "+998 ", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "", city: "Farg'ona viloyati"
        },
        {
            id: 11, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Farg'ona viloyati, Qo'qon shahri, Toshkentliguzar MFY, Tarovat",
            coordinates: [40.535144, 70.937634], phone: "+998 91 050-13-83", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Ulug'bek", city: "Farg'ona viloyati"
        },
        {
            id: 12, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Andijon viloyati, Oltinko'l tumani, Mehnat MSG, Mehnat ko'chasi, 10-uy",
            coordinates: [40.753081, 72.290714], phone: "+998 ", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "", city: "Andijon viloyati"
        },
        {
            id: 13, name: "MCHJ ¬´KAMAZ TEXNIK MARKAZI¬ª",
            address: "Sirdaryo viloyati, Oqoltin tumani, Sardoba shaharchasi A.TOIROV SIU XUDUDI",
            coordinates: [40.536946, 68.325411], phone: "+998 97 706-10-61", email: "shavkat@mail.ru",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Shavkat", city: "Sirdaryo viloyati"
        },
        {
            id: 14, name: "MCHJ ¬´INNOVATSION COMFORT TOMORQA HIZMATLARI¬ª",
            address: "Jizzax viloyati, Jizzax sh. Toshloq mahallasi, Sayiljoyi ko'chasi, 22-uy",
            coordinates: [40.130849, 67.823168], phone: "+998 95 268-33-63", email: "mahmuovjavohir@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Hatamov Bekzod", city: "Jizzax viloyati"
        },
        {
            id: 15, name: "MCHJ ¬´SHARQ GAVHARI TRANS¬ª",
            address: "Surxondaryo viloyati, Termiz shahar, Kattabog ª MFY, Farovon-3 dahasi, 10-uy",
            coordinates: [37.235186, 67.272631], phone: "+998 91 772-04-44", email: "izzat@gmail.com",
            workingHours: "Du-Ju: 9:00-20:00<br>Sha: Dam olish <br>Ya: Dam olish",
            services: ["Sotuv"], manager: "Ergashev Mirjalol Bahrom o'g'li", city: "Surxondaryo viloyati"
        }];

        let map, clusterer, currentFilter = 'all', filteredDealers = [...dealers];
        const UZBEKISTAN_CENTER = [41.377491, 64.585262];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(initializeMap);

        function initializeMap() {
            document.getElementById('mapLoading').style.display = 'none';

            map = new ymaps.Map('map', {
                center: UZBEKISTAN_CENTER,
                zoom: 6,
                controls: ['zoomControl', 'fullscreenControl', 'geolocationControl']
            });

            // –†–ê–ë–û–ß–ï–ï –†–ï–®–ï–ù–ò–ï - –ø–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞–¥ –∫–∞—Ä—Ç–æ–π
            const mapElement = document.getElementById('map');

            mapElement.addEventListener('wheel', (e) => {
                e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            }, { passive: true });

            loadAndDisplayRegions();
            initializeClusterer();
            initializeDealers();
            updateStats();
            setupEventListeners();
        }
        function initializeMap() {
            document.getElementById('mapLoading').style.display = 'none';

            map = new ymaps.Map('map', {
                center: UZBEKISTAN_CENTER,
                zoom: 6,
                controls: ['zoomControl', 'fullscreenControl', 'geolocationControl']
            });

            // –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –¢–û–õ–¨–ö–û –¢–ï–†–†–ò–¢–û–†–ò–ï–ô –£–ó–ë–ï–ö–ò–°–¢–ê–ù–ê
            map.setBounds([
                [37.172, 55.998],  // –Æ–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π —É–≥–æ–ª
                [45.590, 73.132]   // –°–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π —É–≥–æ–ª
            ], {
                checkZoomRange: true,
                preciseZoom: true
            });

            // –ó–∞–ø—Ä–µ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
            map.options.set('restrictMapArea', [
                [37.172, 55.998],
                [45.590, 73.132]
            ]);

            // –†–ê–ë–û–ß–ï–ï –†–ï–®–ï–ù–ò–ï - –ø–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞–¥ –∫–∞—Ä—Ç–æ–π
            const mapElement = document.getElementById('map');

            mapElement.addEventListener('wheel', (e) => {
                e.stopPropagation();
            }, { passive: true });

            loadAndDisplayRegions();
            initializeClusterer();
            initializeDealers();
            updateStats();
            setupEventListeners();
        }
        function loadAndDisplayRegions() {
            const uzbekistanBorder = [
                [37.250789, 67.340123], [37.360214, 67.081543],
                [37.368912, 66.524178], [37.970000, 66.550000],
                [37.981234, 66.551789], [38.410876, 65.221345],
                [38.420567, 65.210123], [38.899123, 64.175892],
                [39.370456, 63.523467], [39.948765, 62.905123],
                [40.060214, 62.379876], [40.505432, 62.005678],
                [40.520123, 61.990456], [41.090123, 61.888456],
                [41.271890, 61.552345], [41.225678, 60.471234],
                [41.430567, 60.088912], [41.440234, 60.080123],
                [42.228456, 59.981789], [42.756789, 58.634567],
                [42.770123, 58.620456], [42.175890, 57.791234],
                [41.831234, 56.937890], [41.327456, 57.101789],
                [41.313890, 55.973456], [41.320123, 55.960789],
                [41.300000, 55.900000], [42.500000, 55.800000],
                [43.200000, 55.600000], [44.100000, 55.750000],
                [44.995858, 55.928917], [45.001234, 55.934123],
                [45.010567, 55.945456], [45.050123, 56.000789],
                [45.070000, 56.050000], [45.100456, 56.120123],
                [45.200789, 56.500456], [45.300123, 56.800789],
                [45.400456, 57.100123], [45.500000, 57.500000],
                [45.505432, 57.505432], [45.592123, 58.508456],
                [45.600789, 58.520123], [45.586804, 58.503127],
                [45.500014, 58.689989], [45.490123, 58.700456],
                [44.789456, 60.245123], [44.800567, 60.250789],
                [44.405817, 61.058320], [43.504477, 62.013300],
                [43.655432, 63.191234], [43.733456, 64.906123],
                [43.740123, 64.920456], [43.002890, 66.103456],
                [42.000123, 66.028789], [41.992890, 66.515432],
                [41.173789, 66.719234], [41.141234, 67.991123],
                [40.667456, 68.265123], [40.673890, 68.637456],
                [41.389456, 69.075123], [41.400123, 69.080456],
                [42.086543, 70.394123], [42.271345, 70.967456],
                [42.172890, 71.264123], [41.525123, 70.425234],
                [41.148789, 71.162890], [41.398123, 71.875234],
                [40.871234, 73.060123], [40.880567, 73.070456],
                [40.151123, 71.780234], [40.249567, 71.019198],
                [40.223789, 70.606543], [40.501678, 70.463234],
                [40.965432, 70.671789], [40.2204216, 69.2579536],
                [40.217000, 69.253000], [40.225000, 69.262000],
                [40.230000, 69.265000], [40.091234, 69.016789],
                [39.800000, 68.900000], [39.650000, 68.750000],
                [39.538789, 68.541234], [39.585123, 67.706543],
                [39.705432, 67.105123], [39.145432, 67.447456],
                [38.906789, 68.181234], [38.162345, 68.397123],
                [38.170123, 68.410456], [37.725123, 68.305432],
                [37.730456, 68.310123], [37.200789, 67.850456],
                [37.195000, 67.845000], [37.190123, 67.840789],
                [37.250789, 67.340123]];


            map.geoObjects.add(new ymaps.Polygon([uzbekistanBorder], {
                hintContent: 'O\'zbekiston Respublikasi'
            }, {
                strokeColor: '#0a2883',
                strokeWidth: 3,
                strokeOpacity: 1,
                fillColor: 'rgba(231, 76, 60, 0.1)',
                fillOpacity: 0
            }));
        }

        function initializeClusterer() {
            clusterer = new ymaps.Clusterer({
                preset: 'islands#blueClusterIcons',
                groupByCoordinates: false,
                clusterDisableClickZoom: false
            });
        }

        function createPlacemark(dealer) {
            return new ymaps.Placemark(dealer.coordinates, {
                id: dealer.id,
                name: dealer.name,
                address: dealer.address,
                phone: dealer.phone,
                balloonContentHeader: `<strong>${dealer.name}</strong>`,
                balloonContentBody: `<div style="padding:10px"><p><strong>üìç Manzil:</strong><br>${dealer.address}</p><p><strong>üìû Telefon:</strong><br><a href="tel:${dealer.phone}">${dealer.phone}</a></p><p><strong>üïí Ish vaqti:</strong><br>${dealer.workingHours}</p><p><strong>üõ†Ô∏è Xizmatlar:</strong><br>${dealer.services.map(s => `<span style="background:#e3f2fd;color:#0a2883;padding:2px 6px;border-radius:4px;font-size:11px;margin:2px">${s}</span>`).join('')}</p><button onclick="showDealerDetails(${dealer.id})" style="background:#0a2883;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;width:100%;margin-top:10px">Batafsil ma'lumot</button></div>`,
                hintContent: `${dealer.name} - ${dealer.city}`
            }, {
                preset: 'islands#redDotIcon',
                iconColor: '#0a2883'
            });
        }

        function initializeDealers() {
            const placemarks = dealers.map(createPlacemark);
            clusterer.add(placemarks);
            map.geoObjects.add(clusterer);

            if (placemarks.length > 0) {
                try {
                    const bounds = clusterer.getBounds();
                    bounds && map.setBounds(bounds, { checkZoomRange: true, zoomMargin: [60, 60, 60, 60] });
                } catch (e) {
                    map.setCenter(UZBEKISTAN_CENTER, 6);
                }
            }
        }

        function showDealerDetails(dealerId) {
            const dealer = dealers.find(d => d.id === dealerId);
            if (!dealer) return;

            document.getElementById('modalTitle').textContent = dealer.name;
            document.getElementById('modalSubtitle').textContent = dealer.city;
            document.getElementById('dealerInfo').innerHTML = `
            <div class="info-item"><div class="info-icon">üìç</div><div class="info-text"><strong>Manzil</strong>${dealer.address}</div></div>
            <div class="info-item"><div class="info-icon">üìû</div><div class="info-text"><strong>Telefon</strong><a href="tel:${dealer.phone}" style="color:#0a2883;text-decoration:none">${dealer.phone}</a></div></div>
            <div class="info-item"><div class="info-icon">‚úâÔ∏è</div><div class="info-text"><strong>Email</strong><a href="mailto:${dealer.email}" style="color:#0a2883;text-decoration:none">${dealer.email}</a></div></div>
            <div class="info-item"><div class="info-icon">üåê</div><div class="info-text"><strong>Veb-sayt</strong><a href="${dealer.website || '#'}" target="_blank" style="color:#0a2883;text-decoration:none">${dealer.website || 'Ko\'rsatilmagan'}</a></div></div>
            <div class="info-item"><div class="info-icon">üïí</div><div class="info-text"><strong>Ish vaqti</strong>${dealer.workingHours}</div></div>
            <div class="info-item"><div class="info-icon">üë§</div><div class="info-text"><strong>Menejer</strong>${dealer.manager || 'Ko\'rsatilmagan'}</div></div>
            <div class="info-item"><div class="info-icon">üõ†Ô∏è</div><div class="info-text"><strong>Xizmatlar</strong><div class="services">${dealer.services.map(s => `<span class="service-tag">${s}</span>`).join('')}</div></div></div>
            <div class="contact-buttons">
                <a href="tel:${dealer.phone}" class="contact-btn btn-primary">üìû Qo'ng'iroq qilish</a>
                <button onclick="buildRoute([${dealer.coordinates}])" class="contact-btn btn-secondary">üó∫Ô∏è Yo'nalish</button>
            </div>`;
            document.getElementById('dealerModal').style.display = 'block';
        }

        function buildRoute(dealerCoordinates) {
            navigator.geolocation ? navigator.geolocation.getCurrentPosition(
                pos => createRoute([pos.coords.latitude, pos.coords.longitude], dealerCoordinates),
                () => createRoute(map.getCenter(), dealerCoordinates)
            ) : createRoute(map.getCenter(), dealerCoordinates);
        }

        function createRoute(from, to) {
            map.geoObjects.each(obj => obj.geometry?.getType() === 'LineString' && map.geoObjects.remove(obj));

            ymaps.route([from, to], { mapStateAutoApply: true, routingMode: 'auto' })
                .then(route => {
                    route.getWayPoints().options.set({ preset: 'islands#redStretchyIcon', iconColor: '#0a2883' });
                    route.getRoutes().options.set({ strokeColor: '#0a2883', strokeWidth: 5, strokeOpacity: 0.9 });
                    map.geoObjects.add(route);
                    document.getElementById('dealerModal').style.display = 'none';
                    setTimeout(() => alert(`Yo'nalish qurildi!\nMasofa: ${(route.getLength() / 1000).toFixed(1)} km\nVaqt: ${Math.round(route.getTime() / 60)} daqiqa`), 500);
                })
                .catch(() => alert('Yo\'nalish qurib bo\'lmadi. Keyinroq urinib ko\'ring.'));
        }

        function setupEventListeners() {
            let timeout;
            document.getElementById('searchBox').addEventListener('input', e => {
                clearTimeout(timeout);
                timeout = setTimeout(() => filterDealers(e.target.value), 300);
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.service;
                    filterDealers(document.getElementById('searchBox').value);
                });
            });

            const modal = document.getElementById('dealerModal');
            document.querySelector('.close').onclick = () => modal.style.display = 'none';
            window.onclick = e => e.target === modal && (modal.style.display = 'none');
            document.addEventListener('keydown', e => e.key === 'Escape' && modal.style.display === 'block' && (modal.style.display = 'none'));
        }

        function filterDealers(query = '') {
            query = query.toLowerCase().trim();
            let filtered = dealers;

            if (query.length >= 2) {
                filtered = filtered.filter(d =>
                    d.name.toLowerCase().includes(query) ||
                    d.address.toLowerCase().includes(query) ||
                    d.city.toLowerCase().includes(query) ||
                    d.manager.toLowerCase().includes(query) ||
                    d.services.some(s => s.toLowerCase().includes(query))
                );
            }

            currentFilter !== 'all' && (filtered = filtered.filter(d => d.services.includes(currentFilter)));
            filteredDealers = filtered;
            updateMapWithDealers(filtered);
            updateStats();
        }

        function updateMapWithDealers(dealers) {
            clusterer.removeAll();
            if (!dealers.length) { updateStats(); return; }

            const placemarks = dealers.map(createPlacemark);
            clusterer.add(placemarks);

            if (dealers.length === 1) {
                map.setCenter(dealers[0].coordinates, 12);
            } else {
                try {
                    const bounds = clusterer.getBounds();
                    bounds && map.setBounds(bounds, { checkZoomRange: true, zoomMargin: [60, 60, 60, 60] });
                } catch (e) { }
            }
        }

        function updateStats() {
            animateNumber(document.getElementById('totalDealers'), dealers.length);
            animateNumber(document.getElementById('visibleDealers'), filteredDealers.length);
            animateNumber(document.getElementById('citiesCount'), new Set(dealers.map(d => d.city)).size);
            animateNumber(document.getElementById('servicesCount'), new Set(dealers.flatMap(d => d.services)).size);
        }

        function animateNumber(el, target) {
            const current = parseInt(el.textContent) || 0;
            const increment = target > current ? 1 : -1;
            const steps = Math.abs(target - current);
            const duration = steps > 0 ? 500 / steps : 0;
            let step = 0;

            const timer = setInterval(() => {
                const val = current + (increment * ++step);
                (increment > 0 && val >= target) || (increment < 0 && val <= target)
                    ? (el.textContent = target, clearInterval(timer))
                    : el.textContent = val;
            }, duration);
        }

        function findNearestDealer() {
            if (!navigator.geolocation) return alert('Brauzeringiz geolokatsiyani qo\'llab-quvvatlamaydi');

            navigator.geolocation.getCurrentPosition(pos => {
                const userCoords = [pos.coords.latitude, pos.coords.longitude];
                let nearest = null, minDist = Infinity;

                dealers.forEach(d => {
                    const dist = calculateDistance(userCoords, d.coordinates);
                    if (dist < minDist) { minDist = dist; nearest = d; }
                });

                nearest && (map.setCenter(nearest.coordinates, 14), setTimeout(() => showDealerDetails(nearest.id), 800));
            }, () => alert('Joylashuvingizni aniqlab bo\'lmadi'));
        }

        function calculateDistance(c1, c2) {
            const R = 6371, dLat = (c2[0] - c1[0]) * Math.PI / 180, dLon = (c2[1] - c1[1]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(c1[0] * Math.PI / 180) * Math.cos(c2[0] * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        window.showDealerDetails = showDealerDetails;
        window.buildRoute = buildRoute;
        window.findNearestDealer = findNearestDealer;
    </script>
</body>

</html>